#!/bin/sh
# Pre-commit hook
# Runs tests before allowing commit
# Prevents committing if tests fail

. "$(dirname "$0")/_/husky.sh"

echo "ğŸ”’ Checking for sensitive files..."

# CRITICAL: Block chat logs with PII from being committed
CHAT_LOGS=$(git diff --cached --name-only | grep -E "chat-logs.*\.json|data/.*\.json")
if [ -n "$CHAT_LOGS" ]; then
    echo "âŒ BLOCKED: Attempting to commit chat logs with PII!"
    echo "   Chat logs contain user data and must NEVER be committed."
    echo "   Files blocked:"
    echo "$CHAT_LOGS" | sed 's/^/     - /'
    echo ""
    echo "   These files are gitignored for security reasons."
    exit 1
fi

echo "âœ… No sensitive files detected"
echo "ğŸ§ª Running pre-commit tests..."

# Run quick tests (security and unit tests)
cd backend
npm test -- tests/security_tests tests/unit_tests/backend 2>&1 | grep -q "Tests.*passed"

if [ $? -eq 0 ]; then
    echo "âœ… Pre-commit tests passed"
    exit 0
else
    echo "âŒ Pre-commit tests failed - commit blocked"
    echo "Fix the failing tests before committing"
    exit 1
fi
