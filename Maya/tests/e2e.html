<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maya Backend Test Dashboard - E2E Test Results</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #e9ecef;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --text-muted: #adb5bd;
      --border-color: #dee2e6;
      --accent-color: #000000;
      --accent-hover: #333333;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
      --shadow: rgba(0, 0, 0, 0.1);
      --shadow-hover: rgba(0, 0, 0, 0.2);
      --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      --transition-fast: 0.15s ease;
      --transition-normal: 0.3s ease;
    }

    [data-theme="dark"] {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --border-color: #30363d;
      --accent-color: #ffffff;
      --accent-hover: #e6e6e6;
      --shadow: rgba(0, 0, 0, 0.3);
      --shadow-hover: rgba(0, 0, 0, 0.5);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-primary);
      background-color: var(--bg-primary);
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--spacing-xl) var(--spacing-lg);
    }

    .header {
      text-align: center;
      margin-bottom: var(--spacing-3xl);
      padding-top: var(--spacing-2xl);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.125rem;
      margin-bottom: var(--spacing-lg);
    }

    .run-tests-button-container {
      display: flex;
      justify-content: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      flex-wrap: wrap;
    }

    .run-tests-btn {
      padding: var(--spacing-md) var(--spacing-xl);
      background-color: var(--accent-color);
      color: var(--bg-primary);
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-family: var(--font-family);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .run-tests-btn:hover {
      background-color: var(--accent-hover);
      border-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }

    .run-tests-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px var(--shadow);
    }

    .run-tests-btn.running {
      background-color: var(--warning-color);
      border-color: var(--warning-color);
      color: var(--text-primary);
      cursor: wait;
    }

    .run-tests-btn.success {
      background-color: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }

    .run-tests-btn.error {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
      color: white;
    }

    /* Dark mode specific adjustments - better contrast */
    [data-theme="dark"] .run-tests-btn {
      background-color: #1f6feb;
      color: white;
      border-color: #1f6feb;
      box-shadow: 0 2px 8px rgba(31, 111, 235, 0.3);
    }

    [data-theme="dark"] .run-tests-btn:hover {
      background-color: #2a7ff0;
      border-color: #2a7ff0;
      color: white;
      box-shadow: 0 4px 12px rgba(31, 111, 235, 0.4);
    }

    [data-theme="dark"] .run-tests-btn:active {
      background-color: #1a5fd6;
      border-color: #1a5fd6;
    }

    .test-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .test-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .test-modal-content {
      background-color: var(--bg-primary);
      border-radius: 12px;
      padding: var(--spacing-xl);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px var(--shadow-hover);
      border: 2px solid var(--border-color);
    }

    .test-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .test-modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.5rem;
    }

    .test-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: var(--spacing-xs);
      line-height: 1;
    }

    .test-modal-close:hover {
      color: var(--text-primary);
    }

    .test-command-box {
      background-color: var(--bg-tertiary);
      border-radius: 8px;
      padding: var(--spacing-md);
      margin: var(--spacing-md) 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      position: relative;
    }

    .copy-command-btn {
      position: absolute;
      top: var(--spacing-sm);
      right: var(--spacing-sm);
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      font-family: var(--font-family);
    }

    .copy-command-btn:hover {
      background-color: var(--accent-hover);
    }

    .copy-command-btn.copied {
      background-color: var(--success-color);
    }

    .date-comparison {
      display: flex;
      justify-content: center;
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-2xl);
      flex-wrap: wrap;
    }

    .date-badge {
      padding: var(--spacing-md) var(--spacing-xl);
      background-color: var(--bg-secondary);
      border-radius: 12px;
      border: 2px solid var(--border-color);
      font-weight: 600;
      color: var(--text-primary);
      min-width: 200px;
      text-align: center;
      transition: all var(--transition-normal);
    }

    .date-badge.current {
      border-color: var(--accent-color);
      background-color: var(--bg-tertiary);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .date-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .date-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
    }

    .date-value {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .time-value {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
    }

    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-3xl);
    }

    .metric-card {
      background-color: var(--bg-secondary);
      border-radius: 12px;
      padding: var(--spacing-xl);
      border: 2px solid var(--border-color);
      transition: all var(--transition-normal);
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px var(--shadow-hover);
      border-color: var(--accent-color);
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .metric-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-icon {
      font-size: 1.5rem;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .metric-change {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .metric-change.positive {
      color: var(--success-color);
    }

    .metric-change.negative {
      color: var(--danger-color);
    }

    .metric-change.neutral {
      color: var(--text-secondary);
    }

    .category-section {
      margin-bottom: var(--spacing-3xl);
    }

    .section-title {
      font-size: 1.875rem;
      font-weight: 700;
      margin-bottom: var(--spacing-xl);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .section-title::after {
      content: "";
      flex: 1;
      height: 2px;
      background-color: var(--border-color);
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--spacing-lg);
      align-items: start; /* Ensure all cards align at the top */
    }

    .category-card {
      background-color: var(--bg-secondary);
      border-radius: 12px;
      padding: var(--spacing-xl);
      border: 2px solid var(--border-color);
      transition: all var(--transition-normal);
      display: flex;
      flex-direction: column;
      height: 100%; /* Make all cards same height */
    }

    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px var(--shadow-hover);
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      flex-shrink: 0; /* Prevent header from shrinking */
      min-height: 32px; /* Consistent header height */
    }

    .category-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2; /* Consistent line height */
    }

    .status-badge {
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.passing {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }

    .status-badge.partial {
      background-color: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
      border: 1px solid var(--warning-color);
    }

    .status-badge.failing {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
    }

    .comparison-bar {
      margin-bottom: var(--spacing-md);
      flex-shrink: 0; /* Prevent comparison bar from shrinking */
      min-height: 64px; /* Consistent height: label (20px) + margin (4px) + bar (32px) + margin (8px) */
    }

    .comparison-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
      font-size: 0.875rem;
      color: var(--text-secondary);
      min-height: 20px; /* Consistent label height */
      align-items: center;
    }

    .bar-container {
      display: flex;
      gap: var(--spacing-xs);
      height: 32px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .bar-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.75rem;
      transition: all var(--transition-normal);
    }

    .bar-segment:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .bar-segment.passing {
      background-color: var(--success-color);
    }

    .bar-segment.failing {
      background-color: var(--danger-color);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      flex-shrink: 0; /* Prevent stats grid from shrinking */
      min-height: 80px; /* Reduced height since labels removed */
    }

    .stat-item {
      text-align: center;
      padding: var(--spacing-md);
      background-color: var(--bg-tertiary);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 70px; /* Slightly increased to accommodate indicator */
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2; /* Consistent line height */
    }

    .stat-indicator {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 2px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      line-height: 1.2; /* Consistent line height */
    }

    .category-note {
      min-height: 60px; /* Consistent minimum height for note section */
      display: flex;
      align-items: center; /* Vertically center note content */
    }

    .chart-container {
      background-color: var(--bg-secondary);
      border-radius: 12px;
      padding: var(--spacing-xl);
      border: 2px solid var(--border-color);
      margin-bottom: var(--spacing-xl);
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }

    .progress-ring {
      width: 120px;
      height: 120px;
      margin: 0 auto;
    }

    .progress-ring svg {
      transform: rotate(-90deg);
    }

    .progress-ring-circle {
      fill: none;
      stroke-width: 8;
      transition: stroke-dashoffset 0.5s ease;
    }

    .progress-ring-bg {
      stroke: var(--bg-tertiary);
    }

    .progress-ring-progress {
      stroke: var(--success-color);
      stroke-linecap: round;
    }

    .progress-ring-progress.warning {
      stroke: var(--warning-color);
    }

    .progress-ring-progress.danger {
      stroke: var(--danger-color);
    }

    .progress-text {
      text-align: center;
      margin-top: var(--spacing-md);
    }

    .progress-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .progress-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .category-breakdown {
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-xl);
      border-top: 2px solid var(--border-color);
    }

    .breakdown-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-xl);
      margin-top: var(--spacing-lg);
    }

    .breakdown-column {
      background-color: var(--bg-primary);
      border-radius: 8px;
      padding: var(--spacing-lg);
      border: 1px solid var(--border-color);
    }

    .breakdown-header {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
    }

    .breakdown-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .breakdown-item:last-child {
      border-bottom: none;
    }

    .breakdown-category {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .breakdown-status {
      font-size: 0.875rem;
      font-weight: 600;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }

    .breakdown-status.passing {
      color: var(--success-color);
      background-color: rgba(40, 167, 69, 0.1);
    }

    .breakdown-status.partial {
      color: var(--warning-color);
      background-color: rgba(255, 193, 7, 0.1);
    }

    .breakdown-status.failing {
      color: var(--danger-color);
      background-color: rgba(220, 53, 69, 0.1);
    }

    .trend-chart-container {
      margin: var(--spacing-xl) 0;
      padding: var(--spacing-lg);
      background-color: var(--bg-primary);
      border-radius: 8px;
    }

    #trend-chart {
      width: 100%;
      max-width: 100%;
      height: auto;
    }

    .trend-legend {
      display: flex;
      justify-content: center;
      gap: var(--spacing-xl);
      margin-top: var(--spacing-md);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .failure-section {
      margin-bottom: var(--spacing-xl);
    }

    .toggle-button {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-lg);
      background-color: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all var(--transition-normal);
    }

    .toggle-button:hover {
      background-color: var(--bg-tertiary);
      border-color: var(--accent-color);
    }

    .toggle-button .toggle-icon {
      font-size: 0.875rem;
      transition: transform var(--transition-normal);
    }

    .failure-details {
      margin-top: var(--spacing-lg);
      padding: var(--spacing-lg);
      background-color: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      transition: all var(--transition-normal);
    }

    .failure-details.hidden {
      display: none;
    }

    .failure-grid {
      display: grid;
      gap: var(--spacing-md);
    }

    .failure-item {
      padding: var(--spacing-md);
      background-color: var(--bg-primary);
      border-radius: 8px;
      border-left: 4px solid var(--danger-color);
      transition: all var(--transition-normal);
    }

    .failure-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .evidence-section {
      padding: var(--spacing-md);
    }

    .evidence-card {
      transition: all var(--transition-normal);
    }

    .evidence-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .failure-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: var(--spacing-sm);
    }

    .failure-test-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9375rem;
    }

    .failure-category {
      font-size: 0.75rem;
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: var(--bg-tertiary);
      border-radius: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .failure-message {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-top: var(--spacing-sm);
      font-family: 'Courier New', monospace;
      background-color: var(--bg-tertiary);
      padding: var(--spacing-sm);
      border-radius: 4px;
      white-space: pre-wrap;
    }

    .toggle-content {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .toggle-switch-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--bg-tertiary);
      border-radius: 8px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--danger-color);
      transition: 0.3s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--success-color);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    .toggle-label {
      flex: 1;
    }

    .instructions {
      margin-top: var(--spacing-sm);
    }

    .instruction-box {
      padding: var(--spacing-md);
      background-color: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 4px solid var(--accent-color);
      font-size: 0.9rem;
    }

    .instruction-box code {
      color: var(--accent-color);
      font-size: 0.9rem;
    }

    .loading-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--accent-color);
      animation: pulse 1.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
      }
      50% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .test-progress-bar-container {
      width: 100%;
      height: 24px;
      background-color: var(--bg-tertiary);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--border-color);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .test-progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, 
        var(--accent-color) 0%, 
        var(--info-color) 50%, 
        var(--accent-color) 100%);
      background-size: 200% 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .test-progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    [data-theme="dark"] .test-progress-bar-fill {
      background: linear-gradient(90deg, 
        #1f6feb 0%, 
        #58a6ff 50%, 
        #1f6feb 100%);
      background-size: 200% 100%;
    }

    @keyframes progressBarAnimation {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .failure-message {
      word-break: break-word;
    }

    .failure-file {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-top: var(--spacing-xs);
      font-family: 'Courier New', monospace;
    }

    .no-failures {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
      font-style: italic;
    }

    @media (max-width: 768px) {
      .breakdown-grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-lg);
      }
    }

    .theme-toggle {
      position: fixed;
      top: var(--spacing-lg);
      right: var(--spacing-lg);
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.25rem;
      transition: all var(--transition-normal);
      z-index: 1000;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .theme-toggle:hover {
      border-color: var(--accent-color);
      background-color: var(--bg-tertiary);
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }

      .overview-grid {
        grid-template-columns: 1fr;
      }

      .category-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .date-comparison {
        flex-direction: column;
        align-items: center;
      }

      .context-grid {
        grid-template-columns: 1fr;
      }

      .context-section {
        padding: var(--spacing-lg);
      }

      .context-section h2 {
        font-size: 1.5rem;
      }

      .strategy-table {
        font-size: 0.875rem;
      }

      .strategy-table th,
      .strategy-table td {
        padding: var(--spacing-sm) var(--spacing-md);
      }

      .strategy-table-container {
        overflow-x: auto;
      }

      .trend-chart-container {
        padding: var(--spacing-md);
      }

      #trend-chart {
        height: 250px;
      }

      .failure-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .failure-category {
        margin-top: var(--spacing-xs);
      }
    }

    .strategy-table-container {
      margin-bottom: var(--spacing-2xl);
    }

    .strategy-table-container h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .strategy-table-container p {
      color: var(--text-secondary);
      line-height: 1.7;
      margin-bottom: var(--spacing-lg);
    }

    .strategy-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--bg-primary);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .strategy-table thead {
      background-color: var(--bg-tertiary);
    }

    .strategy-table th {
      padding: var(--spacing-md) var(--spacing-lg);
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }

    .strategy-table td {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
      vertical-align: top;
    }

    .strategy-table tbody tr:hover {
      background-color: var(--bg-secondary);
      transition: background-color var(--transition-fast);
    }

    .strategy-table tbody tr:last-child td {
      border-bottom: none;
    }

    .strategy-table td strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .strategy-table .table-total {
      background-color: var(--bg-tertiary);
      font-weight: 600;
    }

    .strategy-table .table-total td {
      color: var(--text-primary);
      border-top: 2px solid var(--border-color);
      border-bottom: none;
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
    <span id="theme-icon">üåô</span>
  </button>

  <div class="container">
    <div class="header">
      <h1>Maya Backend Test Dashboard</h1>
      <p>End-to-End Test Results Comparison & Analysis</p>
      <div id="last-refresh-time" style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: var(--spacing-md);">
        Auto-refresh: Every 30 seconds
      </div>
      <div class="run-tests-button-container">
        <button class="run-tests-btn" id="run-e2e-tests-btn" onclick="if(typeof window.showRunTestsModal === 'function') { window.showRunTestsModal(); } else { console.error('showRunTestsModal not available'); alert('Please wait for page to fully load, then try again.'); } return false;">
          üöÄ Run End-to-End Tests
        </button>
      </div>
      <div class="date-comparison">
        <div class="date-badge" id="previous-date">
          <div class="date-label">Previous Run</div>
          <div class="date-value">Loading...</div>
          <div class="time-value">--:--:--</div>
        </div>
        <div class="date-badge current" id="current-date">
          <div class="date-label">Current Run</div>
          <div class="date-value">Loading...</div>
          <div class="time-value">--:--:--</div>
        </div>
      </div>
    </div>


    <!-- Background & Context Section -->
    <div class="context-section">
      <h2>Background & Test Strategy</h2>
      
      <!-- Purpose -->
      <div class="strategy-table-container">
        <h3>üéØ Purpose</h3>
        <p>This dashboard tracks the comprehensive test suite for Maya's backend system, ensuring reliability, security, and performance of Janet Xiu Shi's digital twin. Tests validate KB accuracy, cache performance, security measures, and model guardrails.</p>
      </div>

      <!-- Test Scope Table -->
      <div class="strategy-table-container">
        <h3>üìã Test Scope</h3>
        <table class="strategy-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Focus Areas</th>
              <th>Test Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Knowledge Base Tests</strong></td>
              <td>KB loading, caching, accuracy, and evaluation</td>
              <td id="scope-kb-tests">Loading...</td>
            </tr>
            <tr>
              <td><strong>Unit Tests</strong></td>
              <td>Input sanitization, timeout utilities, import validation</td>
              <td id="scope-unit-tests">Loading...</td>
            </tr>
            <tr>
              <td><strong>Security Tests</strong></td>
              <td>Rate limiting and security measures</td>
              <td id="scope-security-tests">Loading...</td>
            </tr>
            <tr>
              <td><strong>Performance Tests</strong></td>
              <td>API performance, model performance, timeout stress</td>
              <td id="scope-performance-tests">Loading...</td>
            </tr>
            <tr>
              <td><strong>Integration Tests</strong></td>
              <td>Bulk file operations with timeout protection</td>
              <td id="scope-integration-tests">Loading...</td>
            </tr>
            <tr>
              <td><strong>Model Tests</strong></td>
              <td>Prompt injection, jailbreak, and architecture leakage prevention</td>
              <td id="scope-model-tests">Loading...</td>
            </tr>
            <tr class="table-total">
              <td><strong>Total</strong></td>
              <td>Comprehensive backend test coverage</td>
              <td><strong id="scope-total-tests">Loading...</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Methodology Table -->
      <div class="strategy-table-container">
        <h3>üî¨ Methodology</h3>
        <table class="strategy-table">
          <thead>
            <tr>
              <th>Approach</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Test Isolation</strong></td>
              <td>Each test suite runs independently with proper cleanup</td>
            </tr>
            <tr>
              <td><strong>Timeout Protection</strong></td>
              <td>All async operations wrapped with timeout guards</td>
            </tr>
            <tr>
              <td><strong>Direct State Manipulation</strong></td>
              <td>Cache tests use direct state manipulation for accuracy</td>
            </tr>
            <tr>
              <td><strong>Sequential Operations</strong></td>
              <td>Cache hit rate tests use sequential operations</td>
            </tr>
            <tr>
              <td><strong>Flexible Validation</strong></td>
              <td>Content checks balance flexibility with validation rigor</td>
            </tr>
            <tr>
              <td><strong>KPI Evaluation</strong></td>
              <td>8 KPIs tracked for cache and memory performance</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Execution Table -->
      <div class="strategy-table-container">
        <h3>‚öôÔ∏è Execution</h3>
        <table class="strategy-table">
          <thead>
            <tr>
              <th>Aspect</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Test Runner</strong></td>
              <td>Jest with ES modules support</td>
            </tr>
            <tr>
              <td><strong>Execution Time</strong></td>
              <td>~20-30 seconds for full suite</td>
            </tr>
            <tr>
              <td><strong>Average Mean End to End Test Run Time</strong></td>
              <td id="avg-execution-time">Calculating...</td>
            </tr>
            <tr>
              <td><strong>Coverage</strong></td>
              <td id="coverage-info">Loading test coverage data...</td>
            </tr>
            <tr>
              <td><strong>Frequency</strong></td>
              <td>Tests run on code changes and before deployment</td>
            </tr>
            <tr>
              <td><strong>CI/CD</strong></td>
              <td>Integrated into deployment pipeline</td>
            </tr>
            <tr>
              <td><strong>Reporting</strong></td>
              <td>Automated E2E reports generated after each run</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Overview Metrics -->
    <div class="overview-grid">
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">Total Tests</div>
          <div class="metric-icon">üìä</div>
        </div>
        <div class="metric-value" id="total-tests">Loading...</div>
        <div class="metric-change neutral" id="total-tests-change">
          <span>‚Üí</span>
          <span>No change</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">Passing Tests</div>
          <div class="metric-icon">‚úÖ</div>
        </div>
        <div class="metric-value" id="passing-tests">Loading...</div>
        <div class="metric-change neutral" id="passing-tests-change">
          <span>‚Üí</span>
          <span>No change</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">Failing Tests</div>
          <div class="metric-icon">‚ùå</div>
        </div>
        <div class="metric-value" id="failing-tests">Loading...</div>
        <div class="metric-change neutral" id="failing-tests-change">
          <span>‚Üí</span>
          <span>No change</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">Pass Rate</div>
          <div class="metric-icon">üìà</div>
        </div>
        <div class="metric-value" id="pass-rate">Loading...</div>
        <div class="metric-change neutral" id="pass-rate-change">
          <span>‚Üí</span>
          <span>No change</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">Test Suites</div>
          <div class="metric-icon">üìÅ</div>
        </div>
        <div class="metric-value" id="test-suites">Loading...</div>
        <div class="metric-change neutral" id="test-suites-change">
          <span>‚Üí</span>
          <span>No change</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-title">Passing Suites</div>
          <div class="metric-icon">‚úÖ</div>
        </div>
        <div class="metric-value" id="passing-suites">Loading...</div>
        <div class="metric-change neutral" id="passing-suites-change">
          <span>‚Üí</span>
          <span>No change</span>
        </div>
      </div>
    </div>

      <!-- Category Breakdown -->
      <div class="category-section">
        <h2 class="section-title">Test Categories</h2>
        <div class="category-grid" id="test-categories-grid">
          <!-- Knowledge Base Tests -->
          <div class="category-card" id="category-knowledgeBase">
          <div class="category-header">
            <div class="category-name">Knowledge Base</div>
            <div class="status-badge passing">Passing</div>
          </div>
          <div class="comparison-bar">
            <div class="comparison-label">
              <span>Jan 9: 70/70</span>
              <span>Jan 11: 70/70</span>
            </div>
            <div class="bar-container">
              <div class="bar-segment passing" style="width: 100%">100%</div>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-item" data-label="Tests">
              <div class="stat-value">70</div>
              <div class="stat-indicator">Tests</div>
            </div>
            <div class="stat-item" data-label="Pass Rate">
              <div class="stat-value">100%</div>
              <div class="stat-indicator">Pass</div>
            </div>
            <div class="stat-item" data-label="Suites">
              <div class="stat-value">7</div>
              <div class="stat-indicator">Suites</div>
            </div>
          </div>
          <div class="category-note" style="margin-top: auto; padding: var(--spacing-md); background-color: var(--bg-tertiary); border-radius: 8px; flex-shrink: 0;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
              <strong>Note:</strong> ‚úÖ All 70 tests passing! Covers KB loading, caching, accuracy, performance, and evaluation with 8 KPIs tracked.
            </div>
          </div>
        </div>

        <!-- Unit Tests -->
        <div class="category-card" id="category-unit">
          <div class="category-header">
            <div class="category-name">Unit</div>
            <div class="status-badge passing">Passing</div>
          </div>
          <div class="comparison-bar">
            <div class="comparison-label">
              <span>Jan 9: 45/45</span>
              <span>Jan 11: 45/45</span>
            </div>
            <div class="bar-container">
              <div class="bar-segment passing" style="width: 100%">100%</div>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-item" data-label="Tests">
              <div class="stat-value">45</div>
              <div class="stat-indicator">Tests</div>
            </div>
            <div class="stat-item" data-label="Pass Rate">
              <div class="stat-value">100%</div>
              <div class="stat-indicator">Pass</div>
            </div>
            <div class="stat-item" data-label="Suites">
              <div class="stat-value">3</div>
              <div class="stat-indicator">Suites</div>
            </div>
          </div>
          <div class="category-note" style="margin-top: auto; padding: var(--spacing-md); background-color: var(--bg-tertiary); border-radius: 8px; flex-shrink: 0;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
              <strong>Note:</strong> ‚úÖ All 45 tests passing! Validates input sanitization, timeout utilities, and import/export validation.
            </div>
          </div>
        </div>

        <!-- Security Tests -->
        <div class="category-card" id="category-security">
          <div class="category-header">
            <div class="category-name">Security</div>
            <div class="status-badge passing">Passing</div>
          </div>
          <div class="comparison-bar">
            <div class="comparison-label">
              <span>Jan 9: 6/6</span>
              <span>Jan 11: 6/6</span>
            </div>
            <div class="bar-container">
              <div class="bar-segment passing" style="width: 100%">100%</div>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-item" data-label="Tests">
              <div class="stat-value">6</div>
              <div class="stat-indicator">Tests</div>
            </div>
            <div class="stat-item" data-label="Pass Rate">
              <div class="stat-value">100%</div>
              <div class="stat-indicator">Pass</div>
            </div>
            <div class="stat-item" data-label="Suites">
              <div class="stat-value">1</div>
              <div class="stat-indicator">Suites</div>
            </div>
          </div>
          <div class="category-note" style="margin-top: auto; padding: var(--spacing-md); background-color: var(--bg-tertiary); border-radius: 8px; flex-shrink: 0;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
              <strong>Note:</strong> ‚úÖ All 6 tests passing! Validates rate limiting (20 requests per 15 minutes) and security middleware functionality.
            </div>
          </div>
        </div>

        <!-- Performance Tests -->
        <div class="category-card" id="category-performance">
          <div class="category-header">
            <div class="category-name">Performance</div>
            <div class="status-badge passing">Passing</div>
          </div>
          <div class="comparison-bar">
            <div class="comparison-label">
              <span>Jan 9: 24/24</span>
              <span>Jan 11: 24/24</span>
            </div>
            <div class="bar-container">
              <div class="bar-segment passing" style="width: 100%">100%</div>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-item" data-label="Tests">
              <div class="stat-value">24</div>
              <div class="stat-indicator">Tests</div>
            </div>
            <div class="stat-item" data-label="Pass Rate">
              <div class="stat-value">100%</div>
              <div class="stat-indicator">Pass</div>
            </div>
            <div class="stat-item" data-label="Suites">
              <div class="stat-value">3</div>
              <div class="stat-indicator">Suites</div>
            </div>
          </div>
          <div class="category-note" style="margin-top: auto; padding: var(--spacing-md); background-color: var(--bg-tertiary); border-radius: 8px; flex-shrink: 0;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
              <strong>Note:</strong> ‚úÖ All 24 tests passing! Validates API response times, model performance, and timeout stress handling.
            </div>
          </div>
        </div>

        <!-- Integration Tests -->
        <div class="category-card" id="category-integration">
          <div class="category-header">
            <div class="category-name">Integration</div>
            <div class="status-badge passing">Passing</div>
          </div>
          <div class="comparison-bar">
            <div class="comparison-label">
              <span>Jan 9: 5/5</span>
              <span>Jan 11: 5/5</span>
            </div>
            <div class="bar-container">
              <div class="bar-segment passing" style="width: 100%">100%</div>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-item" data-label="Tests">
              <div class="stat-value">5</div>
              <div class="stat-indicator">Tests</div>
            </div>
            <div class="stat-item" data-label="Pass Rate">
              <div class="stat-value">100%</div>
              <div class="stat-indicator">Pass</div>
            </div>
            <div class="stat-item" data-label="Suites">
              <div class="stat-value">1</div>
              <div class="stat-indicator">Suites</div>
            </div>
          </div>
          <div class="category-note" style="margin-top: auto; padding: var(--spacing-md); background-color: var(--bg-tertiary); border-radius: 8px; flex-shrink: 0;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
              <strong>Note:</strong> ‚úÖ All 5 tests passing! Validates bulk file operations with timeout protection and concurrent KB loads.
            </div>
          </div>
        </div>

        <!-- Model Tests -->
        <div class="category-card" id="category-model">
          <div class="category-header">
            <div class="category-name">Model</div>
            <div class="status-badge passing">Passing</div>
          </div>
          <div class="comparison-bar">
            <div class="comparison-label">
              <span>Jan 9: 62/72</span>
              <span>Jan 11: 72/72</span>
            </div>
            <div class="bar-container">
              <div class="bar-segment passing" style="width: 100%">100%</div>
              <div class="bar-segment failing" style="width: 0%">0%</div>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-item" data-label="Tests">
              <div class="stat-value">72</div>
              <div class="stat-indicator">Tests</div>
            </div>
            <div class="stat-item" data-label="Pass Rate">
              <div class="stat-value">100%</div>
              <div class="stat-indicator">Pass</div>
            </div>
            <div class="stat-item" data-label="Suites">
              <div class="stat-value">3</div>
              <div class="stat-indicator">Suites</div>
            </div>
          </div>
          <div class="category-note" style="margin-top: auto; padding: var(--spacing-md); background-color: var(--bg-tertiary); border-radius: 8px; flex-shrink: 0;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
              <strong>Note:</strong> ‚úÖ All 72 tests passing! Enhanced guardrail patterns implemented January 11, 2026.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overall Pass Rate Chart -->
    <div class="chart-container">
      <div class="chart-title">Overall Pass Rate Comparison</div>
      <div style="display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap; gap: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
        <div class="progress-ring">
          <svg width="120" height="120">
            <circle class="progress-ring-circle progress-ring-bg" cx="60" cy="60" r="52"></circle>
            <circle class="progress-ring-circle progress-ring-progress" cx="60" cy="60" r="52"></circle>
          </svg>
          <div class="progress-text">
            <div class="progress-value">--</div>
            <div class="progress-label">Previous Run</div>
          </div>
        </div>
        <div class="progress-ring">
          <svg width="120" height="120">
            <circle class="progress-ring-circle progress-ring-bg" cx="60" cy="60" r="52"></circle>
            <circle class="progress-ring-circle progress-ring-progress" cx="60" cy="60" r="52"></circle>
          </svg>
          <div class="progress-text">
            <div class="progress-value">--</div>
            <div class="progress-label">Current Run</div>
          </div>
        </div>
      </div>

      <!-- Category Breakdown -->
      <div class="category-breakdown">
        <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: var(--spacing-md); color: var(--text-primary); text-align: center;">Category Pass/Fail Details</h4>
        <div class="breakdown-grid">
          <div class="breakdown-column">
            <h5 class="breakdown-header">Previous Run</h5>
            <ul class="breakdown-list" id="previous-breakdown">
              <li class="breakdown-item">
                <span class="breakdown-category">Knowledge Base Tests:</span>
                <span class="breakdown-status passing">70/70 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Unit Tests:</span>
                <span class="breakdown-status passing">45/45 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Security Tests:</span>
                <span class="breakdown-status passing">6/6 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Performance Tests:</span>
                <span class="breakdown-status passing">24/24 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Integration Tests:</span>
                <span class="breakdown-status passing">5/5 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Model Tests:</span>
                <span class="breakdown-status passing">72/72 passing</span>
              </li>
            </ul>
          </div>
          <div class="breakdown-column">
            <h5 class="breakdown-header">Current Run</h5>
            <ul class="breakdown-list" id="current-breakdown">
              <li class="breakdown-item">
                <span class="breakdown-category">Knowledge Base Tests:</span>
                <span class="breakdown-status passing">70/70 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Unit Tests:</span>
                <span class="breakdown-status passing">45/45 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Security Tests:</span>
                <span class="breakdown-status passing">6/6 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Performance Tests:</span>
                <span class="breakdown-status passing">24/24 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Integration Tests:</span>
                <span class="breakdown-status passing">5/5 passing</span>
              </li>
              <li class="breakdown-item">
                <span class="breakdown-category">Model Tests:</span>
                <span class="breakdown-status passing">72/72 passing</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Historical Trend Chart -->
    <div class="chart-container">
      <div class="chart-title">Pass Rate Trend (Last 10 Runs)</div>
      <div class="chart-description" style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background-color: var(--bg-tertiary); border-radius: 8px; font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
        <strong>üìä About the 95% Baseline:</strong> This red dashed line represents our quality threshold. We expect at least <strong>95% of tests to pass</strong> in each run. If the pass rate drops below this baseline, it indicates potential issues that require immediate attention. The baseline helps us quickly identify when test quality degrades and ensures we maintain high standards for Maya's backend reliability.
      </div>
      <div class="trend-chart-container">
        <canvas id="trend-chart" width="800" height="300"></canvas>
      </div>
      <div class="trend-legend">
        <div class="legend-item">
          <span class="legend-color" style="background-color: var(--success-color);"></span>
          <span>Pass Rate</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: var(--danger-color);"></span>
          <span>Baseline (95%) - Quality Threshold</span>
        </div>
      </div>
    </div>

    <!-- Detailed Test Results -->
    <div class="category-section">
      <h2 class="section-title">Detailed Test Results</h2>
      <div class="test-results-section">
        <div class="test-results-tabs">
          <button class="tab-button active" onclick="showTestTab('passing')" id="tab-passing">
            ‚úÖ Passing Tests (222)
        </button>
          <button class="tab-button" onclick="showTestTab('failing')" id="tab-failing">
            ‚ùå Failing Tests (<span id="failing-count">0</span>)
          </button>
          <button class="tab-button" onclick="showTestTab('summary')" id="tab-summary">
            üìä Test Summary
          </button>
          <button class="tab-button" onclick="showTestTab('evidence')" id="tab-evidence">
            ‚úÖ Evidence & Prevention
          </button>
        </div>
        
        <!-- Passing Tests Tab -->
        <div id="tab-content-passing" class="tab-content active">
          <div id="passing-tests-list" class="test-list">
            <!-- Dynamically populated -->
          </div>
        </div>
        
        <!-- Failing Tests Tab -->
        <div id="tab-content-failing" class="tab-content">
          <div id="failure-list" class="failure-grid">
            <!-- Dynamically populated -->
          </div>
        </div>
        
        <!-- Summary Tab -->
        <div id="tab-content-summary" class="tab-content">
          <div id="test-summary-content" class="test-summary">
            <!-- Dynamically populated -->
          </div>
        </div>
        
        <!-- Evidence Tab -->
        <div id="tab-content-evidence" class="tab-content">
          <div id="evidence-content" class="evidence-section">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <!-- Key Improvements -->
    <div class="category-section">
      <h2 class="section-title">Key Improvements</h2>
      <div class="category-grid">
        <div class="category-card">
          <div class="category-header">
            <div class="category-name">‚úÖ Knowledge Base Tests</div>
          </div>
          <div style="color: var(--text-secondary); line-height: 1.7;">
            <p><strong>Status:</strong> Maintained 100% pass rate (70/70 tests)</p>
            <p><strong>Improvements:</strong></p>
            <ul style="margin-left: var(--spacing-lg); margin-top: var(--spacing-sm);">
              <li>Fixed TTL expiration test using direct cache manipulation</li>
              <li>Improved test isolation with enhanced cleanup</li>
              <li>Made content checks more flexible while maintaining validation</li>
              <li>Sequential operations for accurate cache hit rate testing</li>
            </ul>
          </div>
        </div>

        <div class="category-card">
          <div class="category-header">
            <div class="category-name">‚úÖ Model Tests</div>
          </div>
          <div style="color: var(--text-secondary); line-height: 1.7;">
            <p><strong>Status:</strong> 100% pass rate (72/72 tests) ‚úÖ</p>
            <p><strong>Improvements Made (January 11, 2026):</strong></p>
            <ul style="margin-left: var(--spacing-lg); margin-top: var(--spacing-sm);">
              <li>Enhanced leetspeak detection with comprehensive character substitution patterns</li>
              <li>Improved system prompt extraction detection</li>
              <li>Fixed KPI type classification (response time, memory efficiency, KB freshness)</li>
              <li>Enhanced code/implementation detection</li>
              <li>Added number-to-word conversion detection</li>
              <li>Improved pattern matching logic (checks both pattern source and response content)</li>
            </ul>
          </div>
        </div>

        <div class="category-card">
          <div class="category-header">
            <div class="category-name">‚úÖ Connectivity & Error Handling</div>
          </div>
          <div style="color: var(--text-secondary); line-height: 1.7;">
            <p><strong>Status:</strong> Enhanced connection error handling ‚úÖ</p>
            <p><strong>Improvements Made (January 11, 2026):</strong></p>
            <ul style="margin-left: var(--spacing-lg); margin-top: var(--spacing-sm);">
              <li>Pre-flight health check before test execution</li>
              <li>Automatic server status detection</li>
              <li>Enhanced error messages with server start instructions</li>
              <li>checkServerStatus() function for manual verification</li>
              <li>Timeout protection for all API calls (3s health, 5min tests)</li>
              <li>Support for file:// protocol (local HTML file access)</li>
              <li>Clear distinction between server down vs other errors</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Run Tests Modal -->
  <div id="run-tests-modal" class="test-modal">
    <div class="test-modal-content">
      <div id="test-modal-body">
        <!-- Content will be dynamically populated -->
      </div>
    </div>
  </div>

  <script>
    // Security: Development mode detection (for console logging)
    // MUST be declared FIRST before any functions that use it
    const isDevelopment = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' ||
                         window.location.protocol === 'file:';
    
    // Test Results Data Structure
    const TEST_RESULTS_KEY = 'maya_test_results';
    const TEST_HISTORY_KEY = 'maya_test_history';
    const MAX_HISTORY = 20; // Store last 20 runs
    
    // Current test results (will be updated from jest-results.json when loaded)
    // Default values shown until actual test results are loaded
    let currentTestResults = {
      timestamp: new Date().toISOString(),
      totalTests: 0, // Will be updated from jest-results.json
      passingTests: 0,
      failingTests: 0,
      passRate: 0,
      testSuites: 0,
      passingSuites: 0,
      failingSuites: 0,
      executionTime: 0,
      categories: {
        knowledgeBase: { total: 0, passing: 0, failing: 0, suites: 0 },
        unit: { total: 0, passing: 0, failing: 0, suites: 0 },
        security: { total: 0, passing: 0, failing: 0, suites: 0 },
        performance: { total: 0, passing: 0, failing: 0, suites: 0 },
        integration: { total: 0, passing: 0, failing: 0, suites: 0 },
        model: { total: 0, passing: 0, failing: 0, suites: 0 }
      },
      failures: [],
      testFiles: []
    };
    
    // Track whether data has been loaded from jest-results.json or localStorage
    let dataLoaded = false;

    // Parse Jest JSON output (for future integration)
    function parseJestOutput(jestJsonOutput) {
      try {
        const data = typeof jestJsonOutput === 'string' ? JSON.parse(jestJsonOutput) : jestJsonOutput;
        
        const results = {
          timestamp: new Date().toISOString(),
          totalTests: data.numTotalTests || 0,
          passingTests: data.numPassedTests || 0,
          failingTests: data.numFailedTests || 0,
          passRate: data.numTotalTests > 0 ? parseFloat(((data.numPassedTests / data.numTotalTests) * 100).toFixed(1)) : 0,
          testSuites: data.numTotalTestSuites || 0,
          passingSuites: data.numPassedTestSuites || 0,
          failingSuites: data.numFailedTestSuites || 0,
          executionTime: data.startTime && data.testResults ? 
            Math.max(...data.testResults.map(t => t.endTime - t.startTime)) : 0,
          categories: {
            knowledgeBase: { total: 0, passing: 0, failing: 0, suites: 0 },
            unit: { total: 0, passing: 0, failing: 0, suites: 0 },
            security: { total: 0, passing: 0, failing: 0, suites: 0 },
            performance: { total: 0, passing: 0, failing: 0, suites: 0 },
            integration: { total: 0, passing: 0, failing: 0, suites: 0 },
            model: { total: 0, passing: 0, failing: 0, suites: 0 }
          },
          failures: []
        };

        // Parse test results by category and collect all test details
        results.testFiles = [];
        
        if (data.testResults) {
          data.testResults.forEach(testResult => {
            const filePath = testResult.name || '';
            let category = 'unit';
            
            if (filePath.includes('knowledge_tests')) category = 'knowledgeBase';
            else if (filePath.includes('security_tests')) category = 'security';
            else if (filePath.includes('performance_tests')) category = 'performance';
            else if (filePath.includes('integration_tests')) category = 'integration';
            else if (filePath.includes('model_test')) category = 'model';
            else if (filePath.includes('unit_tests')) category = 'unit';
            
            // Count tests from assertionResults array
            const assertionResults = testResult.assertionResults || [];
            let passing = 0;
            let failing = 0;
            const tests = [];
            
            assertionResults.forEach(assertion => {
              tests.push({
                fullName: assertion.fullName || assertion.title || 'Unknown test',
                title: assertion.title || 'Unknown test',
                status: assertion.status,
                duration: assertion.duration || 0
              });
              
              if (assertion.status === 'passed') {
                passing++;
              } else if (assertion.status === 'failed') {
                failing++;
                // Extract failure details
                const failureMessage = assertion.failureMessages && assertion.failureMessages.length > 0
                  ? assertion.failureMessages[0]
                  : (assertion.failureDetails && assertion.failureDetails.length > 0
                      ? assertion.failureDetails[0].message || 'Test failed'
                      : 'Test failed (no error message available)');
                
              // Security: Use generic test identifier instead of full name
              const testId = `Test #${results.failures.length + 1}`;
              
              results.failures.push({
                  testName: testId, // Security: Generic identifier, not descriptive name
                category: 'Test Suite', // Security: Generic category, not specific type
                file: 'test-file', // Security: Generic filename, not actual path
                  filePath: null, // Security: No file path exposed
                  error: truncateErrorMessage(failureMessage, 100), // Security: Limited to 100 chars
                suite: 'test-suite' // Security: Generic suite name
              });
            }
            });
            
            const total = passing + failing;
            
            // Store test file information
            results.testFiles.push({
              path: filePath,
              fileName: filePath.split('/').pop(),
              category: category,
              passing: passing,
              failing: failing,
              total: total,
              tests: tests,
              status: testResult.status || 'passed'
            });
            
            results.categories[category].total += total;
            results.categories[category].passing += passing;
            results.categories[category].failing += failing;
            if (total > 0) results.categories[category].suites += 1;
          });
        }

        return results;
      } catch (error) {
        safeLog('error', 'Error parsing Jest output:', error);
        return null;
      }
    }

    // Load test history
    function loadTestHistory() {
      const stored = localStorage.getItem(TEST_HISTORY_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          safeLog('error', 'Error parsing test history:', e);
          return [];
        }
      }
      return [];
    }

    // Save test history
    function saveTestHistory(results) {
      let history = loadTestHistory();
      history.push({
        timestamp: results.timestamp,
        passRate: results.passRate,
        totalTests: results.totalTests,
        passingTests: results.passingTests,
        failingTests: results.failingTests
      });
      
      // Keep only last MAX_HISTORY runs
      if (history.length > MAX_HISTORY) {
        history = history.slice(-MAX_HISTORY);
      }
      
      localStorage.setItem(TEST_HISTORY_KEY, JSON.stringify(history));
    }

    // Format timestamp for display
    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      };
      return date.toLocaleString('en-US', options);
    }

    function formatDate(isoString) {
      const date = new Date(isoString);
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric'
      };
      return date.toLocaleString('en-US', options);
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      const options = { 
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      };
      return date.toLocaleTimeString('en-US', options);
    }

    // Load and save test results
    function loadPreviousResults() {
      const stored = localStorage.getItem(TEST_RESULTS_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          safeLog('error', 'Error parsing stored test results:', e);
          return null;
        }
      }
      return null;
    }

    function saveCurrentResults() {
      localStorage.setItem(TEST_RESULTS_KEY, JSON.stringify(currentTestResults));
    }

    function updateDashboard() {
      console.log('üîß updateDashboard called');
      console.log('üìä currentTestResults:', {
        totalTests: currentTestResults.totalTests,
        passingTests: currentTestResults.passingTests,
        failingTests: currentTestResults.failingTests,
        testSuites: currentTestResults.testSuites,
        passRate: currentTestResults.passRate
      });
      
      const previousResults = loadPreviousResults();
      console.log('üìä previousResults:', previousResults);
      
      // Update date badges
      if (previousResults) {
        document.getElementById('previous-date').innerHTML = `
          <div class="date-label">Previous Run</div>
          <div class="date-value">${formatDate(previousResults.timestamp)}</div>
          <div class="time-value">${formatTime(previousResults.timestamp)}</div>
        `;
      } else {
        document.getElementById('previous-date').innerHTML = `
          <div class="date-label">Previous Run</div>
          <div class="date-value">No previous data</div>
          <div class="time-value">--:--:--</div>
        `;
      }

      document.getElementById('current-date').innerHTML = `
        <div class="date-label">Current Run</div>
        <div class="date-value">${formatDate(currentTestResults.timestamp)}</div>
        <div class="time-value">${formatTime(currentTestResults.timestamp)}</div>
      `;

      // Update metrics with comparison
      console.log('üìä Calling update metrics functions...');
      if (previousResults) {
        console.log('üìä Using comparison mode');
        updateMetricsWithComparison(previousResults, currentTestResults);
      } else {
        console.log('üìä Using no-comparison mode');
        updateMetricsWithoutComparison(currentTestResults);
      }
      
      // Also explicitly call updateMetricCards to ensure it runs
      console.log('üìä Explicitly calling updateMetricCards...');
      updateMetricCards(currentTestResults);

      // Save current results for next run
      saveCurrentResults();
      
      // Save to history
      saveTestHistory(currentTestResults);
      
      // Update trend chart
      updateTrendChart();
      
      // Update failure list
      updateFailureList(currentTestResults);
      
      // Update category cards with actual test results
      updateCategoryCards(currentTestResults);
      
      // Update metric cards dynamically (called again to ensure it runs)
      updateMetricCards(currentTestResults);
      
      console.log('‚úÖ updateDashboard completed');
      
      // Update Test Scope table dynamically
      updateTestScopeTable(currentTestResults);
      
      // Update Coverage info dynamically
      updateCoverageInfo(currentTestResults);
      
      // Update pass rate comparison (progress rings and breakdowns)
      updatePassRateComparison();
    }
    
    // Update Test Scope table with dynamic test counts
    function updateTestScopeTable(results) {
      if (!results) {
        safeLog('warn', '‚ö†Ô∏è No results available for Test Scope table');
        return;
      }
      
      const categories = results.categories || {};
      
      safeLog('log', 'üìä Updating Test Scope table:', {
        kb: categories.knowledgeBase?.total || 0,
        unit: categories.unit?.total || 0,
        security: categories.security?.total || 0,
        performance: categories.performance?.total || 0,
        integration: categories.integration?.total || 0,
        model: categories.model?.total || 0,
        total: results.totalTests || 0
      });
      
      // Update each category count
      const kbEl = document.getElementById('scope-kb-tests');
      if (kbEl) {
        const kbTotal = categories.knowledgeBase?.total || 0;
        kbEl.textContent = kbTotal > 0 ? `${kbTotal} tests` : 'Loading...';
      }
      
      const unitEl = document.getElementById('scope-unit-tests');
      if (unitEl) {
        const unitTotal = categories.unit?.total || 0;
        unitEl.textContent = unitTotal > 0 ? `${unitTotal} tests` : 'Loading...';
      }
      
      const securityEl = document.getElementById('scope-security-tests');
      if (securityEl) {
        const securityTotal = categories.security?.total || 0;
        securityEl.textContent = securityTotal > 0 ? `${securityTotal} tests` : 'Loading...';
      }
      
      const performanceEl = document.getElementById('scope-performance-tests');
      if (performanceEl) {
        const perfTotal = categories.performance?.total || 0;
        performanceEl.textContent = perfTotal > 0 ? `${perfTotal} tests` : 'Loading...';
      }
      
      const integrationEl = document.getElementById('scope-integration-tests');
      if (integrationEl) {
        const intTotal = categories.integration?.total || 0;
        integrationEl.textContent = intTotal > 0 ? `${intTotal} tests` : 'Loading...';
      }
      
      const modelEl = document.getElementById('scope-model-tests');
      if (modelEl) {
        const modelTotal = categories.model?.total || 0;
        modelEl.textContent = modelTotal > 0 ? `${modelTotal} tests` : 'Loading...';
      }
      
      // Update total
      const totalEl = document.getElementById('scope-total-tests');
      if (totalEl) {
        const total = results.totalTests || 0;
        totalEl.textContent = total > 0 ? `${total} tests` : 'Loading...';
      }
    }
    
    // Update Coverage info dynamically
    function updateCoverageInfo(results) {
      const coverageEl = document.getElementById('coverage-info');
      if (!coverageEl) return;
      
      const totalTests = results.totalTests || 0;
      const testSuites = results.testSuites || 0;
      
      if (totalTests > 0 && testSuites > 0) {
        coverageEl.textContent = `${totalTests} test cases across ${testSuites} test suites`;
      } else {
        coverageEl.textContent = 'Test coverage data not available';
      }
    }
    
    // Update category cards dynamically based on test results
    function updateCategoryCards(results) {
      if (!results) {
        safeLog('warn', '‚ö†Ô∏è No results available for category cards');
        return;
      }
      
      if (!results.categories) {
        safeLog('warn', '‚ö†Ô∏è No categories in results:', results);
        return;
      }
      
      safeLog('log', 'üìä Updating category cards with:', JSON.stringify(results.categories, null, 2));
      
      const categoryMap = {
        knowledgeBase: {
          id: 'category-knowledgeBase',
          name: 'Knowledge Base',
          previousDate: 'Jan 9'
        },
        unit: {
          id: 'category-unit',
          name: 'Unit',
          previousDate: 'Jan 9'
        },
        security: {
          id: 'category-security',
          name: 'Security',
          previousDate: 'Jan 9'
        },
        performance: {
          id: 'category-performance',
          name: 'Performance',
          previousDate: 'Jan 9'
        },
        integration: {
          id: 'category-integration',
          name: 'Integration',
          previousDate: 'Jan 9'
        },
        model: {
          id: 'category-model',
          name: 'Model',
          previousDate: 'Jan 9'
        }
      };
      
      // Get previous results for comparison
      const previousResults = loadPreviousResults();
      const previousCategories = previousResults?.categories || {};
      
      Object.keys(categoryMap).forEach(categoryKey => {
        const category = results.categories[categoryKey];
        const categoryInfo = categoryMap[categoryKey];
        const card = document.getElementById(categoryInfo.id);
        
        if (!card || !category) return;
        
        const total = category.total || 0;
        const passing = category.passing || 0;
        const failing = category.failing || 0;
        const passRate = total > 0 ? ((passing / total) * 100).toFixed(1) : 0;
        const isPassing = failing === 0;
        
        // Get previous values for comparison
        const prevCategory = previousCategories[categoryKey] || {};
        const prevTotal = prevCategory.total || total;
        const prevPassing = prevCategory.passing || passing;
        const prevFailing = prevCategory.failing || 0;
        
        // Update status badge
        const statusBadge = card.querySelector('.status-badge');
        if (statusBadge) {
          statusBadge.className = `status-badge ${isPassing ? 'passing' : 'failing'}`;
          statusBadge.textContent = isPassing ? 'Passing' : 'Failing';
        }
        
        // Update comparison bar
        const comparisonLabel = card.querySelector('.comparison-label');
        if (comparisonLabel) {
          const currentDate = new Date(results.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          comparisonLabel.innerHTML = `
            <span>${categoryInfo.previousDate}: ${prevPassing}/${prevTotal}</span>
            <span>${currentDate}: ${passing}/${total}</span>
          `;
        }
        
        // Update progress bar
        const barContainer = card.querySelector('.bar-container');
        if (barContainer) {
          const passingWidth = total > 0 ? (passing / total) * 100 : 0;
          const failingWidth = total > 0 ? (failing / total) * 100 : 0;
          barContainer.innerHTML = `
            <div class="bar-segment passing" style="width: ${passingWidth}%">${passRate}%</div>
            ${failing > 0 ? `<div class="bar-segment failing" style="width: ${failingWidth}%">${failing} failed</div>` : ''}
          `;
        }
        
        // Update stats grid
        const statItems = card.querySelectorAll('.stat-item');
        statItems.forEach(item => {
          const label = item.getAttribute('data-label');
          const valueEl = item.querySelector('.stat-value');
          if (valueEl) {
            if (label === 'Tests') {
              valueEl.textContent = total;
            } else if (label === 'Pass Rate') {
              valueEl.textContent = `${passRate}%`;
              valueEl.style.color = isPassing ? 'var(--success-color)' : 'var(--danger-color)';
            } else if (label === 'Suites') {
              valueEl.textContent = category.suites || 0;
            }
          }
        });
        
        // Update note section
        const noteEl = card.querySelector('.category-note');
        if (noteEl) {
          if (isPassing) {
            noteEl.innerHTML = `
              <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
                <strong>Note:</strong> ‚úÖ All ${total} tests passing! ${getCategoryDescription(categoryKey)}
              </div>
            `;
          } else {
            noteEl.innerHTML = `
              <div style="font-size: 0.875rem; color: var(--danger-color); line-height: 1.5;">
                <strong>‚ö†Ô∏è Warning:</strong> ${failing} of ${total} tests failing. Check "Failing Tests" tab for details.
              </div>
            `;
          }
        }
      });
    }
    
    // Get category description
    function getCategoryDescription(categoryKey) {
      const descriptions = {
        knowledgeBase: 'Covers KB loading, caching, accuracy, performance, and evaluation with 8 KPIs tracked.',
        unit: 'Validates input sanitization, timeout utilities, and import/export validation.',
        security: 'Validates rate limiting (20 requests per 15 minutes) and security middleware functionality.',
        performance: 'Validates API response times, model performance, and timeout stress handling.',
        integration: 'Validates bulk file operations with timeout protection and concurrent KB loads.',
        model: 'Enhanced guardrail patterns implemented January 11, 2026.'
      };
      return descriptions[categoryKey] || '';
    }

    function updateMetricsWithComparison(previous, current) {
      console.log('üîß updateMetricsWithComparison called', { previous, current });
      safeLog('log', 'üîß updateMetricsWithComparison called', { previous, current });
      
      // Ensure we have valid values
      const currentTotal = current.totalTests || 0;
      const currentPassing = current.passingTests || 0;
      const currentFailing = current.failingTests || 0;
      const currentPassRate = current.passRate || (currentTotal > 0 ? ((currentPassing / currentTotal) * 100).toFixed(1) : 0);
      const currentSuites = current.testSuites || 0;
      const currentPassingSuites = current.passingSuites || 0;
      
      const previousTotal = previous.totalTests || 0;
      const previousPassing = previous.passingTests || 0;
      const previousFailing = previous.failingTests || 0;
      const previousPassRate = previous.passRate || (previousTotal > 0 ? ((previousPassing / previousTotal) * 100) : 0);
      const previousSuites = previous.testSuites || 0;
      const previousPassingSuites = previous.passingSuites || 0;
      
      console.log('üìä Updating metrics with comparison:', {
        current: { total: currentTotal, passing: currentPassing, failing: currentFailing, passRate: currentPassRate, suites: currentSuites },
        previous: { total: previousTotal, passing: previousPassing, failing: previousFailing, passRate: previousPassRate, suites: previousSuites }
      });
      safeLog('log', 'üìä Updating metrics with comparison:', {
        current: { total: currentTotal, passing: currentPassing, failing: currentFailing, passRate: currentPassRate, suites: currentSuites },
        previous: { total: previousTotal, passing: previousPassing, failing: previousFailing, passRate: previousPassRate, suites: previousSuites }
      });
      
      // Total Tests
      const totalEl = document.getElementById('total-tests');
      console.log('üîç total-tests element:', totalEl, 'value:', currentTotal, 'dataLoaded:', dataLoaded);
      if (totalEl) {
        // Show "Loading..." only if data hasn't been loaded yet, otherwise show the actual value (even if 0)
        totalEl.textContent = dataLoaded ? currentTotal : 'Loading...';
        console.log('‚úÖ Updated total-tests to:', totalEl.textContent);
      } else {
        console.error('‚ùå total-tests element not found!');
      }
      const totalChange = currentTotal - previousTotal;
      updateChangeIndicator('total-tests', totalChange, 'tests');

      // Passing Tests
      const passingEl = document.getElementById('passing-tests');
      if (passingEl) {
        passingEl.textContent = dataLoaded ? currentPassing : 'Loading...';
      }
      const passingChange = currentPassing - previousPassing;
      updateChangeIndicator('passing-tests', passingChange, 'tests');

      // Failing Tests
      const failingEl = document.getElementById('failing-tests');
      if (failingEl) {
        failingEl.textContent = currentFailing;
      }
      const failingChange = currentFailing - previousFailing;
      // For failing tests, positive change is bad (negative indicator), negative change is good (positive indicator)
      const failingChangeType = failingChange === 0 ? 'neutral' : (failingChange > 0 ? 'negative' : 'positive');
      updateChangeIndicator('failing-tests', failingChange, 'tests', failingChangeType);

      // Pass Rate
      const passRateEl = document.getElementById('pass-rate');
      if (passRateEl) {
        if (dataLoaded) {
          passRateEl.textContent = typeof currentPassRate === 'number' ? currentPassRate.toFixed(1) + '%' : currentPassRate + '%';
        } else {
          passRateEl.textContent = 'Loading...';
        }
      }
      const passRateChange = parseFloat(currentPassRate) - parseFloat(previousPassRate);
      updateChangeIndicator('pass-rate', passRateChange, '%');

      // Test Suites
      const suitesEl = document.getElementById('test-suites');
      if (suitesEl) {
        suitesEl.textContent = dataLoaded ? currentSuites : 'Loading...';
      }
      const suitesChange = currentSuites - previousSuites;
      updateChangeIndicator('test-suites', suitesChange, 'suite');

      // Passing Suites
      const passingSuitesEl = document.getElementById('passing-suites');
      if (passingSuitesEl) {
        passingSuitesEl.textContent = dataLoaded ? currentPassingSuites : 'Loading...';
      }
      const passingSuitesChange = currentPassingSuites - previousPassingSuites;
      updateChangeIndicator('passing-suites', passingSuitesChange, 'suite');
    }

    function updateMetricsWithoutComparison(current) {
      console.log('üîß updateMetricsWithoutComparison called', { current });
      safeLog('log', 'üîß updateMetricsWithoutComparison called', { current });
      
      // Ensure we have valid values
      const currentTotal = current.totalTests || 0;
      const currentPassing = current.passingTests || 0;
      const currentFailing = current.failingTests || 0;
      const currentPassRate = current.passRate || (currentTotal > 0 ? ((currentPassing / currentTotal) * 100).toFixed(1) : 0);
      const currentSuites = current.testSuites || 0;
      const currentPassingSuites = current.passingSuites || 0;
      
      console.log('üìä Updating metrics without comparison:', {
        total: currentTotal,
        passing: currentPassing,
        failing: currentFailing,
        passRate: currentPassRate,
        suites: currentSuites,
        passingSuites: currentPassingSuites
      });
      safeLog('log', 'üìä Updating metrics without comparison:', {
        total: currentTotal,
        passing: currentPassing,
        failing: currentFailing,
        passRate: currentPassRate,
        suites: currentSuites,
        passingSuites: currentPassingSuites
      });
      
      const totalEl = document.getElementById('total-tests');
      console.log('üîç total-tests element:', totalEl, 'value:', currentTotal, 'dataLoaded:', dataLoaded);
      if (totalEl) {
        totalEl.textContent = dataLoaded ? currentTotal : 'Loading...';
        console.log('‚úÖ Updated total-tests to:', totalEl.textContent);
      } else {
        console.error('‚ùå total-tests element not found!');
      }
      
      const passingEl = document.getElementById('passing-tests');
      if (passingEl) passingEl.textContent = dataLoaded ? currentPassing : 'Loading...';
      
      const failingEl = document.getElementById('failing-tests');
      if (failingEl) failingEl.textContent = currentFailing;
      
      const passRateEl = document.getElementById('pass-rate');
      if (passRateEl) {
        if (dataLoaded) {
          passRateEl.textContent = typeof currentPassRate === 'number' ? currentPassRate.toFixed(1) + '%' : currentPassRate + '%';
        } else {
          passRateEl.textContent = 'Loading...';
        }
      }
      
      const suitesEl = document.getElementById('test-suites');
      if (suitesEl) suitesEl.textContent = dataLoaded ? currentSuites : 'Loading...';
      
      const passingSuitesEl = document.getElementById('passing-suites');
      if (passingSuitesEl) passingSuitesEl.textContent = dataLoaded ? currentPassingSuites : 'Loading...';
      
      // Set all change indicators to "No change" when there's no previous data
      ['total-tests', 'passing-tests', 'failing-tests', 'pass-rate', 'test-suites', 'passing-suites'].forEach(metricId => {
        const card = document.getElementById(metricId)?.closest('.metric-card');
        const changeElement = card?.querySelector('.metric-change');
        if (changeElement) {
          changeElement.className = 'metric-change neutral';
          changeElement.innerHTML = '<span>‚Üí</span><span>No change</span>';
        }
      });
    }

    // Update metric cards (wrapper function that calls appropriate comparison function)
    function updateMetricCards(results, retryCount = 0) {
      console.log('üîß updateMetricCards called', { results, retryCount });
      safeLog('log', 'üîß updateMetricCards called', { 
        totalTests: results?.totalTests,
        passingTests: results?.passingTests,
        testSuites: results?.testSuites,
        retryCount
      });
      
      if (!results) {
        console.warn('‚ö†Ô∏è No results available for metric cards');
        safeLog('warn', '‚ö†Ô∏è No results available for metric cards');
        return;
      }
      
      // Check if DOM elements exist before proceeding
      const totalEl = document.getElementById('total-tests');
      const passingEl = document.getElementById('passing-tests');
      
      if (!totalEl || !passingEl) {
        console.warn('‚ö†Ô∏è DOM elements not found in updateMetricCards, retryCount:', retryCount);
        if (retryCount < 5) {
          // Retry after a short delay
          setTimeout(() => {
            console.log('üîÑ Retrying updateMetricCards...');
            updateMetricCards(results, retryCount + 1);
          }, 100 * (retryCount + 1)); // Exponential backoff
        } else {
          console.error('‚ùå Failed to find DOM elements after 5 retries');
          safeLog('error', '‚ùå Failed to find DOM elements after 5 retries');
        }
        return;
      }
      
      const previousResults = loadPreviousResults();
      console.log('üìä Previous results:', previousResults);
      
      if (previousResults) {
        console.log('üìä Using updateMetricsWithComparison');
        updateMetricsWithComparison(previousResults, results);
      } else {
        console.log('üìä Using updateMetricsWithoutComparison');
        updateMetricsWithoutComparison(results);
      }
      
      // Verify updates worked
      setTimeout(() => {
        const totalElCheck = document.getElementById('total-tests');
        const passingElCheck = document.getElementById('passing-tests');
        console.log('üîç Verification after updateMetricCards:');
        console.log('  total-tests:', totalElCheck?.textContent, 'expected:', results.totalTests);
        console.log('  passing-tests:', passingElCheck?.textContent, 'expected:', results.passingTests);
        
        // If values don't match and we haven't retried too many times, retry once more
        if (totalElCheck && totalElCheck.textContent !== String(results.totalTests || 0) && retryCount === 0) {
          console.warn('‚ö†Ô∏è Values don\'t match after update, retrying once...');
          setTimeout(() => updateMetricCards(results, 1), 200);
        }
      }, 100);
    }

    function updateChangeIndicator(metricId, change, unit, forceType = null) {
      const metricEl = document.getElementById(metricId);
      if (!metricEl) return;
      
      const card = metricEl.closest('.metric-card');
      if (!card) return;
      
      const changeElement = card.querySelector('.metric-change');
      if (!changeElement) return;
      
      // Handle percentage units differently
      const isPercentage = unit === '%';
      const absChange = Math.abs(change);
      
      if (change === 0 || absChange < 0.01) {
        changeElement.className = 'metric-change neutral';
        changeElement.innerHTML = '<span>‚Üí</span><span>No change</span>';
      } else {
        // Determine change type
        let changeType = forceType;
        if (!changeType) {
          changeType = change > 0 ? 'positive' : 'negative';
        }
        
        // Special handling for failing tests - more failures is bad
        if (metricId === 'failing-tests' && change > 0) {
          changeType = 'negative';
        } else if (metricId === 'failing-tests' && change < 0) {
          changeType = 'positive';
        }
        
        changeElement.className = `metric-change ${changeType}`;
        
        const sign = change > 0 ? '+' : '-';
        const arrow = change > 0 ? '‚Üë' : '‚Üì';
        
        if (isPercentage) {
          changeElement.innerHTML = `<span>${arrow}</span><span>${sign}${absChange.toFixed(1)}%</span>`;
        } else {
          const plural = absChange !== 1 ? 's' : '';
          const unitText = unit === 'suite' ? (absChange === 1 ? ' suite' : ' suites') : (absChange === 1 ? ' test' : ' tests');
          changeElement.innerHTML = `<span>${arrow}</span><span>${sign}${absChange}${unitText}</span>`;
        }
      }
    }

    // Initialize dashboard
    updateDashboard();

    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('theme-icon');
      icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    // Calculate progress ring
    function updateProgressRing(selector, percentage) {
      const circle = document.querySelector(selector);
      if (!circle) return;
      
      const radius = 52;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percentage / 100) * circumference;
      
      circle.style.strokeDasharray = circumference;
      circle.style.strokeDashoffset = offset;
    }

    // Update category breakdown
    function updateCategoryBreakdown(containerId, results) {
      const container = document.getElementById(containerId);
      if (!container) {
        safeLog('warn', '‚ö†Ô∏è Breakdown container not found:', containerId);
        return;
      }

      const categories = results.categories || {};
      
      // Initialize categories with defaults if missing
      const kb = categories.knowledgeBase || { total: 0, passing: 0, failing: 0 };
      const unit = categories.unit || { total: 0, passing: 0, failing: 0 };
      const security = categories.security || { total: 0, passing: 0, failing: 0 };
      const performance = categories.performance || { total: 0, passing: 0, failing: 0 };
      const integration = categories.integration || { total: 0, passing: 0, failing: 0 };
      const model = categories.model || { total: 0, passing: 0, failing: 0 };
      
      safeLog('log', 'üìä Updating breakdown for', containerId, ':', {
        kb: `${kb.passing}/${kb.total}`,
        unit: `${unit.passing}/${unit.total}`,
        security: `${security.passing}/${security.total}`,
        performance: `${performance.passing}/${performance.total}`,
        integration: `${integration.passing}/${integration.total}`,
        model: `${model.passing}/${model.total}`
      });
      
      container.innerHTML = `
        <li class="breakdown-item">
          <span class="breakdown-category">Knowledge Base Tests:</span>
          <span class="breakdown-status ${kb.failing === 0 ? 'passing' : 'partial'}">
            ${kb.passing}/${kb.total} passing${kb.failing > 0 ? ` (${kb.failing} failing)` : ''}
          </span>
        </li>
        <li class="breakdown-item">
          <span class="breakdown-category">Unit Tests:</span>
          <span class="breakdown-status ${unit.failing === 0 ? 'passing' : 'partial'}">
            ${unit.passing}/${unit.total} passing${unit.failing > 0 ? ` (${unit.failing} failing)` : ''}
          </span>
        </li>
        <li class="breakdown-item">
          <span class="breakdown-category">Security Tests:</span>
          <span class="breakdown-status ${security.failing === 0 ? 'passing' : 'partial'}">
            ${security.passing}/${security.total} passing${security.failing > 0 ? ` (${security.failing} failing)` : ''}
          </span>
        </li>
        <li class="breakdown-item">
          <span class="breakdown-category">Performance Tests:</span>
          <span class="breakdown-status ${performance.failing === 0 ? 'passing' : 'partial'}">
            ${performance.passing}/${performance.total} passing${performance.failing > 0 ? ` (${performance.failing} failing)` : ''}
          </span>
        </li>
        <li class="breakdown-item">
          <span class="breakdown-category">Integration Tests:</span>
          <span class="breakdown-status ${integration.failing === 0 ? 'passing' : 'partial'}">
            ${integration.passing}/${integration.total} passing${integration.failing > 0 ? ` (${integration.failing} failing)` : ''}
          </span>
        </li>
        <li class="breakdown-item">
          <span class="breakdown-category">Model Tests:</span>
          <span class="breakdown-status ${model.failing === 0 ? 'passing' : 'partial'}">
            ${model.passing}/${model.total} passing${model.failing > 0 ? ` (${model.failing} failing)` : ''}
          </span>
        </li>
      `;
    }

    // Update progress rings and breakdowns - called after test results are loaded
    function updatePassRateComparison() {
      const previousResults = loadPreviousResults();
      const currentPassRate = currentTestResults.passRate || 0;
      const previousPassRate = previousResults ? (previousResults.passRate || 0) : currentPassRate;
      
      safeLog('log', 'üîÑ Updating pass rate comparison...');
      safeLog('log', '   Current pass rate:', currentPassRate);
      safeLog('log', '   Previous pass rate:', previousPassRate);
      safeLog('log', '   Current categories:', currentTestResults.categories);
      
      // Update progress rings - use more specific selectors
      const progressRings = document.querySelectorAll('.progress-ring');
      if (progressRings.length >= 2) {
        // Update first ring (previous run)
        const prevRing = progressRings[0];
        const prevProgress = prevRing.querySelector('.progress-ring-progress');
        if (prevProgress) {
          updateProgressRing('.progress-ring:first-child .progress-ring-progress', previousPassRate);
        }
        
        // Update second ring (current run)
        const currRing = progressRings[1];
        const currProgress = currRing.querySelector('.progress-ring-progress');
        if (currProgress) {
          updateProgressRing('.progress-ring:last-child .progress-ring-progress', currentPassRate);
        }
        
        // Update progress ring labels
        if (previousResults && previousResults.passRate !== undefined && previousResults.categories) {
          const prevValue = prevRing.querySelector('.progress-value');
          const prevLabel = prevRing.querySelector('.progress-label');
          if (prevValue) prevValue.textContent = previousPassRate.toFixed(1) + '%';
          if (prevLabel) prevLabel.textContent = formatDate(previousResults.timestamp);
          updateCategoryBreakdown('previous-breakdown', previousResults);
        } else {
          // Use current results as placeholder for previous if no previous data
          const prevValue = prevRing.querySelector('.progress-value');
          const prevLabel = prevRing.querySelector('.progress-label');
          if (prevValue) prevValue.textContent = '--';
          if (prevLabel) prevLabel.textContent = 'No previous data';
          updateCategoryBreakdown('previous-breakdown', currentTestResults);
        }
        
        const currValue = currRing.querySelector('.progress-value');
        const currLabel = currRing.querySelector('.progress-label');
        if (currValue) currValue.textContent = currentPassRate.toFixed(1) + '%';
        if (currLabel) currLabel.textContent = formatDate(currentTestResults.timestamp);
        updateCategoryBreakdown('current-breakdown', currentTestResults);
        
        safeLog('log', '‚úÖ Pass rate comparison updated');
      } else {
        safeLog('warn', '‚ö†Ô∏è Progress rings not found');
      }
    }

    // Update trend chart
    function updateTrendChart() {
      const history = loadTestHistory();
      const canvas = document.getElementById('trend-chart');
      if (!canvas) return;
      
      // If no history but we have current test results, use current as first data point
      let chartData = history;
      if (history.length === 0 && currentTestResults.totalTests > 0) {
        chartData = [{
          timestamp: currentTestResults.timestamp,
          passRate: currentTestResults.passRate || 0,
          totalTests: currentTestResults.totalTests || 0,
          passingTests: currentTestResults.passingTests || 0
        }];
        safeLog('log', 'üìä Trend chart: Using current run as first data point (no history)');
      }
      
      if (chartData.length === 0) {
        safeLog('log', '‚ÑπÔ∏è Trend chart: No data available');
        return;
      }

      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const padding = 40;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Set up styles
      const computedStyle = getComputedStyle(document.documentElement);
      ctx.font = '12px ' + computedStyle.getPropertyValue('--font-family');
      ctx.fillStyle = computedStyle.getPropertyValue('--text-secondary');
      ctx.strokeStyle = computedStyle.getPropertyValue('--border-color');
      ctx.lineWidth = 2;

      // Draw axes
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();

      // Draw baseline (95%) - Quality threshold
      // Position: 10% from top = 90% from bottom (clear visual separation from 100% data points)
      // This creates significant gap between baseline and perfect pass rate
      ctx.strokeStyle = 'rgba(220, 53, 69, 0.6)';
      ctx.setLineDash([8, 4]);
      ctx.lineWidth = 2;
      const baselineY = padding + (chartHeight * 0.10); // 10% from top = 90% from bottom (clear separation)
      ctx.beginPath();
      ctx.moveTo(padding, baselineY);
      ctx.lineTo(width - padding, baselineY);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.lineWidth = 3; // Reset for data points

      // Draw baseline label with background for better visibility
      ctx.fillStyle = 'rgba(220, 53, 69, 0.9)';
      ctx.font = 'bold 11px ' + computedStyle.getPropertyValue('--font-family');
      const labelText = '95% Baseline';
      const labelWidth = ctx.measureText(labelText).width;
      const labelX = width - padding - labelWidth - 10;
      const labelY = baselineY - 8;
      
      // Draw label background for contrast
      ctx.fillStyle = computedStyle.getPropertyValue('--bg-primary');
      ctx.fillRect(labelX - 4, labelY - 10, labelWidth + 8, 14);
      
      // Draw label text
      ctx.fillStyle = 'rgba(220, 53, 69, 0.9)';
      ctx.fillText(labelText, labelX, labelY);

      // Draw data points (with visual separation from baseline)
      const dataPoints = chartData.slice(-10); // Last 10 runs
      const pointSpacing = dataPoints.length > 1 ? chartWidth / (dataPoints.length - 1) : 0;
      
      ctx.strokeStyle = computedStyle.getPropertyValue('--success-color');
      ctx.fillStyle = computedStyle.getPropertyValue('--success-color');
      ctx.lineWidth = 3;

      ctx.beginPath();
      dataPoints.forEach((point, index) => {
        const x = padding + (index * pointSpacing);
        const y = height - padding - (chartHeight * (point.passRate / 100));
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        // Draw point with slight glow effect for better visibility
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2); // Slightly larger radius (4 -> 5)
        ctx.fill();
        
        // Add subtle outline for better contrast
        ctx.strokeStyle = computedStyle.getPropertyValue('--success-color');
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.lineWidth = 3; // Reset for line
      });

      // Draw line
      ctx.stroke();

      // Draw labels
      ctx.fillStyle = computedStyle.getPropertyValue('--text-secondary');
      ctx.font = '10px ' + computedStyle.getPropertyValue('--font-family');
      dataPoints.forEach((point, index) => {
        const x = padding + (index * pointSpacing);
        const date = new Date(point.timestamp);
        const label = `${date.getMonth() + 1}/${date.getDate()}`;
        ctx.save();
        ctx.translate(x, height - padding + 20);
        ctx.rotate(-Math.PI / 4);
        ctx.fillText(label, 0, 0);
        ctx.restore();
      });

      // Y-axis labels
      ctx.fillStyle = computedStyle.getPropertyValue('--text-secondary');
      ctx.font = '11px ' + computedStyle.getPropertyValue('--font-family');
      for (let i = 0; i <= 5; i++) {
        const value = 100 - (i * 20);
        const y = padding + (chartHeight * (i / 5));
        ctx.fillText(value + '%', 5, y + 4);
      }
    }

    // Update failure list
    function updateFailureList(results) {
      const container = document.getElementById('failure-list');
      if (!container) {
        safeLog('warn', '‚ö†Ô∏è failure-list container not found');
        return;
      }

      const failures = results.failures || [];
      safeLog('log', 'üìä Updating failure list - Failures found:', failures.length);
      // Security: Do not log full failure data structure
      
      // Update failing count in tab button
      const failingCountEl = document.getElementById('failing-count');
      if (failingCountEl) {
        failingCountEl.textContent = failures.length;
      }
      
      if (failures.length === 0) {
        container.innerHTML = '<div class="no-failures">‚úÖ No failing tests! All tests passing.</div>';
        return;
      }

      // Security: Display generic identifiers, no file paths or detailed information
      container.innerHTML = failures.map((failure, index) => {
        return `
        <div class="failure-item">
          <div class="failure-header">
            <div>
              <div class="failure-test-name">${index + 1}. ${escapeHtml(failure.testName || 'Test Case')}</div>
              <div class="failure-file" style="display: none;">
                <!-- Security: File paths removed from display -->
              </div>
            </div>
            <div class="failure-category" style="display: none;">
              <!-- Security: Category information removed -->
            </div>
          </div>
          <div class="failure-message">${escapeHtml(failure.error || 'Test failed (no error message available)')}</div>
        </div>
      `;
      }).join('');
    }

    // Security: Truncate error messages to prevent information leakage
    // Note: isDevelopment is declared at the top of the script (line ~1916)
    function truncateErrorMessage(message, maxLength = 100) {
      if (!message || typeof message !== 'string') {
        return 'Test failed (no error message available)';
      }
      
      // Remove assertion details (Expected/Received) for security
      let sanitized = message
        .replace(/Expected:\s*[^\n]+/gi, 'Expected: [REDACTED]')
        .replace(/Received:\s*[^\n]+/gi, 'Received: [REDACTED]')
        .replace(/expect\([^)]+\)\.toBe[^\n]*/gi, 'Assertion failed')
        .replace(/AssertionError[^\n]*/gi, 'Assertion failed');
      
      // Truncate to max length
      if (sanitized.length > maxLength) {
        sanitized = sanitized.substring(0, maxLength - 3) + '...';
      }
      
      return sanitized;
    }

    // Update Evidence tab content
    function updateEvidence() {
      const container = document.getElementById('evidence-content');
      if (!container) {
        safeLog('warn', '‚ö†Ô∏è evidence-content container not found');
        return;
      }
      
      // Generate evidence content based on current test results
      const evidenceHTML = `
        <div class="evidence-card">
          <h3>‚úÖ Test Execution Evidence</h3>
          <ul class="summary-list">
            <li><strong>Test Results File:</strong> <code>Maya/tests/jest-results.json</code></li>
            <li><strong>Test Execution:</strong> Verified via Jest JSON output</li>
            <li><strong>All Tests:</strong> Run via <code>npm test</code> in backend directory</li>
            <li><strong>Timestamp:</strong> ${new Date(currentTestResults.timestamp).toLocaleString()}</li>
            <li><strong>Command:</strong> <code>cd Maya/backend && npm test</code></li>
            <li><strong>Total Tests:</strong> ${currentTestResults.totalTests || 0}</li>
            <li><strong>Passing Tests:</strong> ${currentTestResults.passingTests || 0}</li>
            <li><strong>Test Suites:</strong> ${currentTestResults.testSuites || 0}</li>
            <li><strong>Pass Rate:</strong> ${currentTestResults.passRate || 0}%</li>
          </ul>
        </div>
        <div class="evidence-card">
          <h3>üîÑ Test Re-runnability</h3>
          <p>All tests can be re-run independently and globally without side effects.</p>
          <p><strong>Status:</strong> ‚úÖ Verified - Tests are isolated and re-runnable</p>
        </div>
        <div class="evidence-card">
          <h3>üö´ No Recursive Execution</h3>
          <p>Test files do not execute the test runner, preventing infinite loops.</p>
          <p><strong>Status:</strong> ‚úÖ Verified - No recursive test execution detected</p>
        </div>
        <div class="evidence-card">
          <h3>üîí Test Isolation</h3>
          <p>Each test suite runs independently with proper cleanup and isolation.</p>
          <p><strong>Status:</strong> ‚úÖ Verified - Tests are properly isolated</p>
        </div>
        <div class="evidence-card">
          <h3>‚ö° CPU Usage Prevention</h3>
          <p>Measures in place to prevent high CPU usage and system freezes.</p>
          <p><strong>Status:</strong> ‚úÖ Verified - CPU usage monitoring and prevention active</p>
        </div>
        <div class="evidence-card">
          <h3>‚úÖ Preserved Functionality</h3>
          <p>All existing functionality remains intact after test improvements.</p>
          <p><strong>Status:</strong> ‚úÖ Verified - All ${currentTestResults.totalTests || 0} tests passing</p>
        </div>
      `;
      
      container.innerHTML = evidenceHTML;
      safeLog('log', '‚úÖ Evidence tab updated');
    }

    // Security: Safe console logging (only in development)
    function safeLog(level, ...args) {
      if (!isDevelopment) return; // No logging in production
      if (level === 'log') console.log(...args);
      else if (level === 'error') console.error(...args);
      else if (level === 'warn') console.warn(...args);
      else if (level === 'debug') console.debug(...args);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Show test tab
    function showTestTab(tab) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Show selected tab
      const contentEl = document.getElementById(`tab-content-${tab}`);
      const buttonEl = document.getElementById(`tab-${tab}`);
      if (contentEl) contentEl.classList.add('active');
      if (buttonEl) buttonEl.classList.add('active');
    }

    // Update passing tests list
    function updatePassingTestsList(results) {
      const container = document.getElementById('passing-tests-list');
      if (!container) {
        safeLog('warn', '‚ö†Ô∏è passing-tests-list container not found');
        return;
      }

      const testFiles = results.testFiles || [];
      
      if (testFiles.length === 0) {
        safeLog('log', '‚ÑπÔ∏è No test files found in results, using default data');
        // Try to populate with default structure if no test files
        container.innerHTML = '<div class="no-failures">üìä No test file details available. Run tests to see detailed results.</div>';
        return;
      }
      
      safeLog('log', 'üìä Updating passing tests list with', testFiles.length, 'test files');

      container.innerHTML = testFiles.map((fileData) => {
        const fileName = fileData.fileName || fileData.path.split('/').pop();
        const totalTests = fileData.total || (fileData.passing + fileData.failing);
        const tests = fileData.tests || [];
        const testItems = tests.slice(0, 10).map(test => 
          `<div class="test-item">${escapeHtml(test.fullName || test.title || 'Test')}</div>`
        ).join('');
        const moreTests = tests.length > 10 ? 
          `<div class="test-item" style="color: var(--text-muted); font-style: italic;">... and ${tests.length - 10} more tests</div>` : '';
        
        return `
          <div class="test-file-group">
            <div class="test-file-header">
              <div>
                <div class="test-file-name">${escapeHtml(fileName)}</div>
                <a href="${getTestFileLink(fileName, fileData.path)}" class="test-file-link" target="_blank">View File ‚Üí</a>
              </div>
              <div class="test-file-stats">
                ${fileData.passing || 0}/${totalTests} passing
              </div>
            </div>
            <div class="test-items">
              ${testItems}
              ${moreTests}
            </div>
          </div>
        `;
      }).join('');
    }

    // Update test summary
    function updateTestSummary(results) {
      const container = document.getElementById('test-summary-content');
      if (!container) {
        safeLog('warn', '‚ö†Ô∏è test-summary-content container not found');
        return;
      }
      
      safeLog('log', 'üìä Updating test summary with results:', {
        totalTests: results.totalTests,
        passingTests: results.passingTests,
        failingTests: results.failingTests,
        testFiles: results.testFiles?.length || 0
      });

      const summary = {
        totalTests: results.totalTests || 0,
        passingTests: results.passingTests || 0,
        failingTests: results.failingTests || 0,
        testSuites: results.testSuites || 0,
        executionTime: results.executionTime || 0,
        testFiles: results.testFiles || [],
        coverage: results.coverage || null,
        timestamp: results.timestamp || new Date().toISOString()
      };

      // Group test files by category
      const filesByCategory = {
        knowledgeBase: [],
        unit: [],
        security: [],
        performance: [],
        integration: [],
        model: []
      };

      summary.testFiles.forEach(file => {
        const path = file.path || '';
        if (path.includes('knowledge_tests')) filesByCategory.knowledgeBase.push(file);
        else if (path.includes('security_tests')) filesByCategory.security.push(file);
        else if (path.includes('performance_tests')) filesByCategory.performance.push(file);
        else if (path.includes('integration_tests')) filesByCategory.integration.push(file);
        else if (path.includes('model_test')) filesByCategory.model.push(file);
        else filesByCategory.unit.push(file);
      });

      const allTestsPassing = summary.failingTests === 0;
      const coverageDisplay = summary.coverage && allTestsPassing ? generateCoverageDisplay(summary.coverage, filesByCategory) : '';

      container.innerHTML = `
        <div class="summary-card">
          <h3>üìä Overall Statistics</h3>
          <ul class="summary-list">
            <li><strong>Total Tests:</strong> ${summary.totalTests}</li>
            <li><strong>Passing:</strong> <span style="color: var(--success-color);">${summary.passingTests}</span></li>
            <li><strong>Failing:</strong> <span style="color: var(--danger-color);">${summary.failingTests}</span></li>
            <li><strong>Pass Rate:</strong> ${summary.totalTests > 0 ? ((summary.passingTests / summary.totalTests) * 100).toFixed(1) : 0}%</li>
            <li><strong>Test Suites:</strong> ${summary.testSuites}</li>
            <li><strong>Execution Time:</strong> ${(summary.executionTime / 1000).toFixed(2)}s</li>
          </ul>
        </div>
        ${coverageDisplay}
        <div class="summary-card">
          <h3>üìÅ Test Files by Category</h3>
          ${Object.entries(filesByCategory).map(([category, files]) => {
            if (files.length === 0) return '';
            const categoryName = category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, ' $1').trim();
            return `
              <div style="margin-bottom: var(--spacing-md);">
                <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">${categoryName} (${files.length} files)</h4>
                <ul class="summary-list">
                  ${files.map(file => {
                    const fileName = file.fileName || file.path.split('/').pop();
                    const totalTests = file.total || (file.passing + file.failing);
                    return `<li>
                      <a href="${getTestFileLink(fileName, file.path)}" class="test-file-link" target="_blank">${escapeHtml(fileName)}</a>
                      <span style="color: var(--text-muted);"> (${totalTests} tests, ${file.passing || 0} passing)</span>
                    </li>`;
                  }).join('')}
                </ul>
              </div>
            `;
          }).join('')}
        </div>
        <div class="summary-card">
          <h3>‚úÖ Evidence</h3>
          <ul class="summary-list">
            <li><strong>Test Results File:</strong> <code>Maya/tests/jest-results.json</code></li>
            ${summary.coverage ? `<li><strong>Coverage File:</strong> <code>Maya/tests/coverage/coverage-summary.json</code></li>` : ''}
            <li><strong>Test Execution:</strong> Verified via Jest JSON output</li>
            <li><strong>All Tests:</strong> Run via <code>npm test</code> in backend directory</li>
            <li><strong>Timestamp:</strong> ${new Date(summary.timestamp).toLocaleString()}</li>
            <li><strong>Command:</strong> <code>cd Maya/backend && npm test</code></li>
          </ul>
          
          <!-- High-Level Summary -->
          <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">üìã Test Execution Summary</h4>
            <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <div>
                  <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: var(--spacing-xs);">Total Test Files</div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">
                    ${Object.values(filesByCategory).reduce((sum, files) => sum + files.length, 0)}
                  </div>
                </div>
                <div>
                  <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: var(--spacing-xs);">Test Suites</div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">
                    ${summary.testSuites || 0}
                  </div>
                </div>
                <div>
                  <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: var(--spacing-xs);">Total Tests</div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">
                    ${summary.totalTests || 0}
                  </div>
                </div>
                <div>
                  <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: var(--spacing-xs);">Execution Time</div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">
                    ${(summary.executionTime / 1000).toFixed(2)}s
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Test Files by Category Summary -->
            <div style="margin-top: var(--spacing-md);">
              <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary); font-size: 1rem;">üìÅ Test Files Executed by Category</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-sm);">
                ${Object.entries(filesByCategory).map(([category, files]) => {
                  if (files.length === 0) return '';
                  const categoryName = category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, ' $1').trim();
                  const totalTestsInCategory = files.reduce((sum, file) => sum + (file.total || (file.passing + file.failing) || 0), 0);
                  const passingInCategory = files.reduce((sum, file) => sum + (file.passing || 0), 0);
                  const failingInCategory = files.reduce((sum, file) => sum + (file.failing || 0), 0);
                  
                  return `
                    <div style="background-color: var(--bg-tertiary); border-radius: 6px; padding: var(--spacing-sm); border-left: 3px solid ${failingInCategory > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">
                      <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">${categoryName}</div>
                      <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        <div>${files.length} file${files.length !== 1 ? 's' : ''}</div>
                        <div style="margin-top: 2px;">
                          <span style="color: var(--success-color);">${passingInCategory} passing</span>
                          ${failingInCategory > 0 ? `<span style="color: var(--danger-color); margin-left: var(--spacing-xs);">${failingInCategory} failing</span>` : ''}
                        </div>
                        <div style="margin-top: 2px; color: var(--text-muted);">${totalTestsInCategory} total tests</div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <!-- Detailed Test Files List (Collapsible) -->
            <div style="margin-top: var(--spacing-md);">
              <details style="cursor: pointer;">
                <summary style="font-weight: 600; color: var(--text-primary); padding: var(--spacing-sm); background-color: var(--bg-tertiary); border-radius: 6px; user-select: none;">
                  üìÑ View All Test Files (${Object.values(filesByCategory).reduce((sum, files) => sum + files.length, 0)} files)
                </summary>
                <div style="margin-top: var(--spacing-sm); padding: var(--spacing-md); background-color: var(--bg-tertiary); border-radius: 6px; max-height: 400px; overflow-y: auto;">
                  ${Object.entries(filesByCategory).map(([category, files]) => {
                    if (files.length === 0) return '';
                    const categoryName = category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, ' $1').trim();
                    return `
                      <div style="margin-bottom: var(--spacing-md);">
                        <h5 style="margin-bottom: var(--spacing-xs); color: var(--text-primary); font-size: 0.9rem; font-weight: 600;">${categoryName}</h5>
                        <ul style="margin: 0; padding-left: var(--spacing-lg); list-style: none;">
                          ${files.map(file => {
                            const fileName = file.fileName || file.path.split('/').pop();
                            const totalTests = file.total || (file.passing + file.failing) || 0;
                            const passing = file.passing || 0;
                            const failing = file.failing || 0;
                            const statusColor = failing > 0 ? 'var(--danger-color)' : 'var(--success-color)';
                            const statusIcon = failing > 0 ? '‚ùå' : '‚úÖ';
                            return `
                              <li style="margin-bottom: var(--spacing-xs); padding: var(--spacing-xs); background-color: var(--bg-primary); border-radius: 4px;">
                                <span style="color: ${statusColor}; margin-right: var(--spacing-xs);">${statusIcon}</span>
                                <a href="${getTestFileLink(fileName, file.path)}" class="test-file-link" target="_blank" style="color: var(--accent-color); text-decoration: none;">
                                  ${escapeHtml(fileName)}
                                </a>
                                <span style="color: var(--text-muted); font-size: 0.875rem; margin-left: var(--spacing-xs);">
                                  (${totalTests} tests: <span style="color: var(--success-color);">${passing} passing</span>
                                  ${failing > 0 ? `<span style="color: var(--danger-color);">, ${failing} failing</span>` : ''})
                                </span>
                              </li>
                            `;
                          }).join('')}
                        </ul>
                      </div>
                    `;
                  }).join('')}
                </div>
              </details>
            </div>
          </div>
        </div>
      `;
    }

    // Generate coverage display
    function generateCoverageDisplay(coverage, filesByCategory) {
      if (!coverage || !coverage.total) return '';

      const total = coverage.total;
      const coveragePercent = total.lines ? total.lines.pct : 0;
      const coverageColor = coveragePercent >= 80 ? 'var(--success-color)' : coveragePercent >= 60 ? 'var(--warning-color)' : 'var(--danger-color)';

      return `
        <div class="summary-card">
          <h3>üìà Test Coverage</h3>
          <div style="margin-bottom: var(--spacing-md);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
              <strong>Overall Coverage:</strong>
              <span style="font-size: 1.2rem; font-weight: bold; color: ${coverageColor};">
                ${coveragePercent.toFixed(1)}%
              </span>
            </div>
            <div style="background-color: var(--bg-tertiary); height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background-color: ${coverageColor}; height: 100%; width: ${coveragePercent}%; transition: width 0.3s;"></div>
            </div>
          </div>
          <ul class="summary-list">
            <li><strong>Statements:</strong> ${total.statements ? total.statements.pct.toFixed(1) : 0}%</li>
            <li><strong>Branches:</strong> ${total.branches ? total.branches.pct.toFixed(1) : 0}%</li>
            <li><strong>Functions:</strong> ${total.functions ? total.functions.pct.toFixed(1) : 0}%</li>
            <li><strong>Lines:</strong> ${total.lines ? total.lines.pct.toFixed(1) : 0}%</li>
          </ul>
          ${Object.entries(filesByCategory).map(([category, files]) => {
            if (files.length === 0) return '';
            const categoryName = category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, ' $1').trim();
            const categoryCoverage = coverage[category] || null;
            if (!categoryCoverage) return '';
            const catPercent = categoryCoverage.lines ? categoryCoverage.lines.pct : 0;
            return `
              <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                  <strong>${categoryName}:</strong>
                  <span style="color: ${catPercent >= 80 ? 'var(--success-color)' : catPercent >= 60 ? 'var(--warning-color)' : 'var(--danger-color)'};">
                    ${catPercent.toFixed(1)}%
                  </span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Get test file link (relative to workspace root)
    function getTestFileLink(fileName, fullPath) {
      if (fullPath) {
        // Extract relative path from full path
        const relativePath = fullPath.includes('tests/') 
          ? fullPath.split('tests/')[1] 
          : fileName;
        return relativePath;
      }
      // Try to determine category from common patterns
      if (fileName.includes('kb-') || fileName.includes('knowledge')) {
        return `knowledge_tests/${fileName}`;
      } else if (fileName.includes('model') || fileName.includes('prompt') || fileName.includes('jailbreak') || fileName.includes('architecture')) {
        return `model_test/${fileName}`;
      } else if (fileName.includes('security') || fileName.includes('rateLimit')) {
        return `security_tests/${fileName}`;
      } else if (fileName.includes('performance') || fileName.includes('api') || fileName.includes('timeout')) {
        return `performance_tests/${fileName}`;
      } else if (fileName.includes('integration') || fileName.includes('bulk')) {
        return `integration_tests/${fileName}`;
      } else if (fileName.includes('sanitize') || fileName.includes('timeout') || fileName.includes('import')) {
        return `unit_tests/backend/${fileName}`;
      }
      // Default fallback
      return fileName;
    }

    // Load test results from Jest JSON output (if available)
    // This function loads results from jest-results.json in the same directory
    // First tries localStorage (for file:// protocol compatibility), then falls back to fetch
    async function loadJestResults() {
      try {
        console.log('üîÑ Attempting to load jest-results.json...');
        safeLog('log', 'üîÑ Attempting to load jest-results.json...');
        
        // FIRST: Try to load from localStorage (works even with file:// protocol)
        // This is populated before page reload, so it should have the latest data
        console.log('üîç Checking localStorage for maya_latest_test_results...');
        const storedResults = localStorage.getItem('maya_latest_test_results');
        console.log('üîç localStorage.getItem result:', storedResults ? 'Found data' : 'No data found');
        
        if (storedResults) {
          try {
            const parsedStored = JSON.parse(storedResults);
            console.log('‚úÖ Found test results in localStorage:', {
              totalTests: parsedStored.totalTests,
              passingTests: parsedStored.passingTests,
              testSuites: parsedStored.testSuites
            });
            
            // Use stored results if they're recent (within last 5 minutes)
            const storedTime = new Date(parsedStored.timestamp);
            const now = new Date();
            const ageMinutes = (now - storedTime) / (1000 * 60);
            
            if (ageMinutes < 5) {
              console.log('‚úÖ Using localStorage data (age:', ageMinutes.toFixed(1), 'minutes)');
              currentTestResults = {
                ...currentTestResults,
                ...parsedStored,
                categories: parsedStored.categories || currentTestResults.categories,
                testFiles: parsedStored.testFiles || currentTestResults.testFiles,
                failures: parsedStored.failures || currentTestResults.failures
              };
              
              // Mark data as loaded
              dataLoaded = true;
              
              // Update dashboard with stored data
              updateDashboard();
              updateTrendChart();
              updatePassRateComparison();
              updateFailureList(currentTestResults);
              updatePassingTestsList(currentTestResults);
              updateTestSummary(currentTestResults);
              updateEvidence();
              updateCategoryCards(parsedStored);
              updateMetricCards(parsedStored);
              
              console.log('‚úÖ Dashboard updated from localStorage');
              safeLog('log', '‚úÖ Loaded test results from localStorage');
              
              // Still try to fetch fresh data in background (for HTTP protocol)
              // but don't wait for it
              if (window.location.protocol !== 'file:') {
                fetch('./jest-results.json?t=' + Date.now(), { cache: 'no-store' })
                  .then(response => {
                    if (response.ok) {
                      return response.json();
                    }
                    return null;
                  })
                  .then(jestData => {
                    if (jestData) {
                      const parsed = parseJestOutput(jestData);
                      if (parsed && parsed.totalTests > 0) {
                        // Update with fresh data
                        currentTestResults = {
                          ...currentTestResults,
                          ...parsed
                        };
                        updateDashboard();
                        updateMetricCards(parsed);
                        updateCategoryCards(parsed);
                        console.log('‚úÖ Updated with fresh fetch data');
                      }
                    }
                  })
                  .catch(err => {
                    // Silently fail - we already have localStorage data
                    console.log('‚ÑπÔ∏è Background fetch failed, using localStorage data');
                  });
              }
              
              return true;
            } else {
              console.log('‚ö†Ô∏è localStorage data too old (', ageMinutes.toFixed(1), 'minutes), fetching fresh...');
            }
          } catch (parseError) {
            console.warn('‚ö†Ô∏è Failed to parse localStorage data:', parseError);
          }
        }
        
        // SECOND: Try to fetch from file (works with HTTP protocol)
        // Add cache-busting query parameter to ensure fresh data after reload
        const cacheBuster = '?t=' + Date.now();
        const url = './jest-results.json' + cacheBuster;
        console.log('üì° Fetching from:', url);
        
        let response;
        try {
          response = await fetch(url, {
            cache: 'no-store' // Force no cache
          });
          console.log('üì° Response status:', response.status, response.statusText);
        } catch (fetchError) {
          console.error('‚ùå Fetch error:', fetchError);
          console.error('‚ùå Error details:', {
            name: fetchError.name,
            message: fetchError.message,
            stack: fetchError.stack
          });
          safeLog('error', '‚ùå Failed to fetch jest-results.json:', fetchError);
          // If fetch fails (e.g., CORS issue with file://), try alternative approach
          if (window.location.protocol === 'file:') {
            console.warn('‚ö†Ô∏è file:// protocol detected. Fetch may fail due to CORS restrictions.');
            console.warn('‚ö†Ô∏è Consider serving via HTTP server or using a local server.');
          }
          return false;
        }
        
        if (response.ok) {
          let jestData;
          try {
            jestData = await response.json();
            console.log('‚úÖ Successfully fetched and parsed jest-results.json');
            console.log('üìä Jest data keys:', Object.keys(jestData));
            console.log('üìä Jest data summary:', {
              numTotalTests: jestData.numTotalTests,
              numPassedTests: jestData.numPassedTests,
              numTotalTestSuites: jestData.numTotalTestSuites
            });
            safeLog('log', '‚úÖ Successfully fetched jest-results.json');
          } catch (jsonError) {
            console.error('‚ùå JSON parse error:', jsonError);
            safeLog('error', '‚ùå Failed to parse jest-results.json as JSON:', jsonError);
            return false;
          }
          
          const parsed = parseJestOutput(jestData);
          if (!parsed) {
            console.error('‚ùå parseJestOutput returned null/undefined');
            safeLog('error', '‚ùå parseJestOutput returned null/undefined');
            return false;
          }
          console.log('‚úÖ parseJestOutput succeeded');
          if (parsed) {
            // Update current test results with parsed data - deep merge to preserve structure
            console.log('üìä Parsed data:', {
              totalTests: parsed.totalTests,
              passingTests: parsed.passingTests,
              failingTests: parsed.failingTests,
              testSuites: parsed.testSuites,
              passRate: parsed.passRate
            });
            
            currentTestResults = {
              ...currentTestResults,
              ...parsed,
              categories: parsed.categories || currentTestResults.categories,
              testFiles: parsed.testFiles || currentTestResults.testFiles,
              failures: parsed.failures || currentTestResults.failures
            };
            
            // Mark data as loaded
            dataLoaded = true;
            
            // Store in localStorage for file:// protocol compatibility
            try {
              localStorage.setItem('maya_latest_test_results', JSON.stringify(parsed));
              console.log('‚úÖ Stored test results in localStorage');
            } catch (storageError) {
              console.warn('‚ö†Ô∏è Failed to store in localStorage:', storageError);
            }
            
            console.log('üìä Updated currentTestResults:', {
              totalTests: currentTestResults.totalTests,
              passingTests: currentTestResults.passingTests,
              failingTests: currentTestResults.failingTests,
              testSuites: currentTestResults.testSuites,
              passRate: currentTestResults.passRate
            });
            
            safeLog('log', '‚úÖ Loaded actual test results from jest-results.json');
            safeLog('log', 'üìä Total Tests:', parsed.totalTests);
            safeLog('log', 'üìä Test Suites:', parsed.testSuites);
            safeLog('log', 'üìä Test Files:', parsed.testFiles?.length || 0);
            safeLog('log', '‚úÖ Passing Tests:', parsed.passingTests || 0);
            safeLog('log', '‚ùå Failing Tests:', parsed.failingTests || 0);
            safeLog('log', 'üìä Pass Rate:', parsed.passRate);
            // Security: Do not log categories or failures array details
            safeLog('log', 'üìä Failures array length:', parsed.failures?.length || 0);
            
            // Update dashboard components - ensure ALL metrics are updated
            console.log('üîÑ Updating dashboard with loaded results...');
            console.log('üìä Results data:', {
              totalTests: parsed.totalTests,
              passingTests: parsed.passingTests,
              failingTests: parsed.failingTests,
              passRate: parsed.passRate,
              testSuites: parsed.testSuites
            });
            safeLog('log', 'üîÑ Updating dashboard with loaded results...');
            safeLog('log', 'üìä Results data:', {
              totalTests: parsed.totalTests,
              passingTests: parsed.passingTests,
              failingTests: parsed.failingTests,
              passRate: parsed.passRate,
              testSuites: parsed.testSuites
            });
            
            // Update ALL dashboard components
            updateDashboard(); // This calls updateMetricCards, updateCategoryCards, etc.
            updateTrendChart();
            
            // Update pass rate comparison with actual data
            updatePassRateComparison();
            
            // Update Detailed Test Results section
            safeLog('log', 'üîÑ Updating Detailed Test Results sections...');
            updateFailureList(currentTestResults);
            updatePassingTestsList(currentTestResults);
            updateTestSummary(currentTestResults);
            updateEvidence();
            
            // Explicitly update category cards and metric cards again to ensure they're updated
            console.log('üîÑ Explicitly updating category cards and metric cards...');
            safeLog('log', 'üîÑ Explicitly updating category cards and metric cards...');
            updateCategoryCards(parsed);
            updateMetricCards(parsed);
            
            // Verify updates worked
            setTimeout(() => {
              const totalEl = document.getElementById('total-tests');
              const passingEl = document.getElementById('passing-tests');
              const suitesEl = document.getElementById('test-suites');
              console.log('üîç Verification after loadJestResults:');
              console.log('  total-tests element:', totalEl, 'value:', totalEl?.textContent);
              console.log('  passing-tests element:', passingEl, 'value:', passingEl?.textContent);
              console.log('  test-suites element:', suitesEl, 'value:', suitesEl?.textContent);
              console.log('  Expected values:', {
                total: parsed.totalTests,
                passing: parsed.passingTests,
                suites: parsed.testSuites
              });
            }, 200);
            
            safeLog('log', '‚úÖ All dashboard components updated with fresh data');
            
            // Update failing count in tab button
            const failingCountEl = document.getElementById('failing-count');
            if (failingCountEl) {
              failingCountEl.textContent = parsed.failingTests || 0;
            }
            // Update passing count in tab button
            const passingTabEl = document.getElementById('tab-passing');
            if (passingTabEl) {
              passingTabEl.textContent = `‚úÖ Passing Tests (${parsed.passingTests || 0})`;
            }
            
            safeLog('log', '‚úÖ All Detailed Test Results sections updated');
            return true;
          } else {
            safeLog('warn', '‚ö†Ô∏è Failed to parse Jest output');
            // Mark data as loaded even if parsing failed, so UI shows "0" instead of "Loading..."
            console.log('‚ö†Ô∏è Marking dataLoaded = true after parse failure (to show "0" instead of "Loading...")');
            dataLoaded = true;
            updateDashboard();
          }
        } else {
          safeLog('log', '‚ÑπÔ∏è jest-results.json not found (status:', response.status, ')');
          // Mark data as loaded even if file not found, so UI shows "0" instead of "Loading..."
          console.log('‚ö†Ô∏è Marking dataLoaded = true after file not found (to show "0" instead of "Loading...")');
          dataLoaded = true;
          updateDashboard();
        }
      } catch (error) {
        // File not available or fetch failed (e.g., CORS with file:// protocol)
        console.error('‚ùå Error loading jest-results.json:', error);
        console.error('‚ùå Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        safeLog('error', '‚ùå Error loading jest-results.json:', error);
        safeLog('log', '‚ÑπÔ∏è Using default test results. Run tests with --json to generate jest-results.json');
        
        // If it's a CORS error with file:// protocol, show helpful message
        if (window.location.protocol === 'file:' && (error.name === 'TypeError' || error.message.includes('fetch'))) {
          console.error('‚ùå CORS Error: Cannot fetch jest-results.json via file:// protocol');
          console.error('üí° Solution: Serve e2e.html via HTTP server (e.g., python -m http.server) or use a local development server');
          // Try to show a user-visible error message
          const errorMsg = document.createElement('div');
          errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff4444; color: white; padding: 15px; border-radius: 8px; z-index: 10000; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);';
          errorMsg.innerHTML = '<strong>‚ö†Ô∏è CORS Error</strong><br>Cannot load jest-results.json via file:// protocol.<br><br><strong>Solution:</strong> Serve e2e.html via HTTP server:<br><code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px;">cd Maya/tests && python3 -m http.server 8080</code><br>Then open: <code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px;">http://localhost:8080/e2e.html</code>';
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 15000);
        }
        
        // CRITICAL: Even if loading fails, mark data as loaded so UI shows "0" instead of "Loading..."
        // This prevents the dashboard from showing "Loading..." indefinitely when data can't be loaded
        console.log('‚ö†Ô∏è Marking dataLoaded = true even though load failed (to show "0" instead of "Loading...")');
        dataLoaded = true;
        
        // Update dashboard with default/empty data so it shows "0" instead of "Loading..."
        updateDashboard();
      }
      return false;
    }

    // Get dynamic test counts from jest-results.json or currentTestResults
    async function getTestCounts() {
      // Try to load from jest-results.json first
      try {
        const cacheBuster = '?t=' + Date.now();
        const response = await fetch('./jest-results.json' + cacheBuster, {
          cache: 'no-store'
        });
        if (response.ok) {
          const jestData = await response.json();
          return {
            totalTests: jestData.numTotalTests || 0,
            totalSuites: jestData.numTotalTestSuites || 0,
            passingTests: jestData.numPassedTests || 0,
            passingSuites: jestData.numPassedTestSuites || 0
          };
        }
      } catch (error) {
        safeLog('log', '‚ÑπÔ∏è Could not load jest-results.json, using currentTestResults');
      }
      
      // Fallback to currentTestResults if available
      if (currentTestResults && currentTestResults.totalTests) {
        return {
          totalTests: currentTestResults.totalTests,
          totalSuites: currentTestResults.testSuites || 0,
          passingTests: currentTestResults.passingTests || 0,
          passingSuites: currentTestResults.passingSuites || 0
        };
      }
      
      // Default fallback (should rarely be used)
      return {
        totalTests: 0,
        totalSuites: 0,
        passingTests: 0,
        passingSuites: 0
      };
    }

    // Run Tests Modal Functions
    // Define function first, then assign to window for global access
    async function showRunTestsModal() {
      try {
        console.log('üöÄ Run tests button clicked - showRunTestsModal called');
        safeLog('log', 'üöÄ Run tests button clicked');
        
        // Get dynamic test counts FIRST (before confirmation dialog)
        let counts = { totalTests: 0, totalSuites: 0, passingTests: 0, passingSuites: 0 };
        try {
          counts = await getTestCounts();
          console.log('üìä Test counts retrieved:', counts);
          safeLog('log', 'üìä Test counts retrieved:', counts);
        } catch (error) {
          console.warn('‚ö†Ô∏è Failed to get test counts, using defaults:', error.message);
          safeLog('warn', '‚ö†Ô∏è Failed to get test counts, using defaults:', error.message);
          // Use defaults - counts already set above
        }
        
        const testCountText = counts.totalTests > 0 
          ? `${counts.totalSuites} suite${counts.totalSuites !== 1 ? 's' : ''}, ${counts.totalTests} test${counts.totalTests !== 1 ? 's' : ''}`
          : 'all test suites';
        
        console.log('üìã Showing confirmation dialog with:', testCountText);
        safeLog('log', 'üìã Showing confirmation dialog with:', testCountText);
        
        // Show confirmation dialog FIRST (before server check)
        const confirmed = confirm(
          `Are you sure you want to run end-to-end tests?\n\n` +
          `This will:\n` +
          `‚Ä¢ Run ${testCountText}\n` +
          `‚Ä¢ Take approximately 20-30 seconds\n` +
          `‚Ä¢ Update dashboard with results\n\n` +
          `Click OK to proceed or Cancel to abort.`
        );
        
        if (!confirmed) {
          console.log('‚ùå User cancelled test execution');
          safeLog('log', '‚ùå User cancelled test execution');
          return; // User cancelled
        }
        
        console.log('‚úÖ User confirmed, checking server status...');
        safeLog('log', '‚úÖ User confirmed, checking server status...');
        
        // NOW check server status (after user confirmed)
        const backendUrl = window.location.origin.includes('localhost') || window.location.protocol === 'file:'
          ? 'http://localhost:3001' 
          : window.location.origin.replace(/:\d+/, ':3001');
        
        let serverAvailable = false;
        try {
          // Use timeout with AbortController for better browser compatibility
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 2000);
          
          const healthResponse = await fetch(`${backendUrl}/health`, {
            method: 'GET',
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          serverAvailable = healthResponse.ok;
        } catch (error) {
          console.warn('‚ö†Ô∏è Server health check failed:', error.message);
          safeLog('warn', '‚ö†Ô∏è Server health check failed:', error.message);
          serverAvailable = false;
        }
        
        if (!serverAvailable) {
          // Show server status check modal instead
          console.warn('‚ö†Ô∏è Server not available, showing connection error modal');
          safeLog('warn', '‚ö†Ô∏è Server not available, showing connection error modal');
          checkServerStatus();
          return;
        }
        
        console.log('‚úÖ Server is available, starting test execution...');
        safeLog('log', '‚úÖ Server is available, starting test execution...');
        
        // User confirmed AND server is available - trigger test run
        runE2ETests();
      } catch (error) {
        console.error('‚ùå Error in showRunTestsModal:', error);
        safeLog('error', '‚ùå Error in showRunTestsModal:', error);
        // Show error to user
        alert(`Error: Unable to start test execution. Please check the console for details.\n\nError: ${error.message}`);
      }
    }
    
    // Make function globally accessible for onclick handler
    window.showRunTestsModal = showRunTestsModal;
    
    async function runE2ETests() {
      const btn = document.getElementById('run-e2e-tests-btn');
      const modal = document.getElementById('run-tests-modal');
      const modalBody = document.getElementById('test-modal-body');
      
      // Track progress
      const startTime = Date.now();
      const expectedDuration = 45000; // 45 seconds average
      let progressInterval = null;
      let currentProgress = 0;
      let currentTestSuite = 'Initializing...';
      const testSuites = [
        'Knowledge Base Tests',
        'Unit Tests',
        'Security Tests',
        'Performance Tests',
        'Integration Tests',
        'Model Tests'
      ];
      
      // Update progress function
      const updateProgress = () => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(95, (elapsed / expectedDuration) * 100);
        currentProgress = progress;
        
        // Update current test suite based on progress
        const suiteProgress = Math.floor((progress / 100) * testSuites.length);
        if (suiteProgress < testSuites.length) {
          currentTestSuite = testSuites[suiteProgress];
        } else {
          currentTestSuite = 'Finalizing results...';
        }
        
        // Update modal content
        if (modalBody) {
          const progressBarFill = modalBody.querySelector('.test-progress-bar-fill');
          const currentTestEl = modalBody.querySelector('.current-test-name');
          const progressText = modalBody.querySelector('.progress-text');
          
          if (progressBarFill) {
            progressBarFill.style.width = `${progress}%`;
          }
          if (currentTestEl) {
            currentTestEl.textContent = currentTestSuite;
          }
          if (progressText) {
            progressText.textContent = `${Math.floor(progress)}%`;
            // Also update the progress text above the bar if it exists
            const progressTextAbove = modalBody.querySelector('.progress-text');
            if (progressTextAbove && progressTextAbove !== progressText) {
              progressTextAbove.textContent = `${Math.floor(progress)}%`;
            }
          }
        }
      };
      
      // Update button state
      if (btn) {
        btn.classList.add('running');
        btn.textContent = 'üîÑ Running Tests...';
        btn.disabled = true;
      }
      
      // Show modal with progress
      if (modal) {
        modal.classList.add('active');
        modalBody.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üîÑ</div>
            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">Running End-to-End Tests</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
              Please wait while tests are executing...
            </p>
            <!-- Current Test Suite -->
            <div style="margin-bottom: var(--spacing-md);">
              <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-xs);">Current Test Suite:</p>
              <p class="current-test-name" style="color: var(--accent-color); font-weight: 600; font-size: 1rem;">${currentTestSuite}</p>
            </div>
            <!-- Progress Bar -->
            <div style="width: 100%; max-width: 500px; margin: 0 auto var(--spacing-lg);">
              <div style="margin-bottom: var(--spacing-sm); text-align: center;">
                <span class="progress-text" style="color: var(--text-primary); font-size: 1.25rem; font-weight: 700;">0%</span>
              </div>
              <div class="test-progress-bar-container">
                <div class="test-progress-bar-fill" style="width: 0%;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: var(--spacing-xs);">
                <span style="color: var(--text-muted); font-size: 0.75rem;">Progress</span>
                <span style="color: var(--text-muted); font-size: 0.75rem;">Estimated: ~45s</span>
              </div>
            </div>
            <div style="display: flex; justify-content: center; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
              <div class="loading-dot" style="animation-delay: 0s;"></div>
              <div class="loading-dot" style="animation-delay: 0.2s;"></div>
              <div class="loading-dot" style="animation-delay: 0.4s;"></div>
            </div>
          </div>
        `;
        
        // Start progress updates immediately
        updateProgress(); // Call once immediately to show initial state
        progressInterval = setInterval(updateProgress, 200); // Update every 200ms
      }
      
      try {
        // Get backend URL (default to current origin or localhost:3001)
        const backendUrl = window.location.origin.includes('localhost') || window.location.protocol === 'file:'
          ? 'http://localhost:3001' 
          : window.location.origin.replace(/:\d+/, ':3001');
        
        // Check server health first
        let serverAvailable = false;
        try {
          // Use AbortController for better browser compatibility
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000);
          
          const healthResponse = await fetch(`${backendUrl}/health`, {
            method: 'GET',
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          serverAvailable = healthResponse.ok;
        } catch (healthError) {
          serverAvailable = false;
        }
        
        if (!serverAvailable) {
          throw new Error('SERVER_NOT_RUNNING');
        }
        
        // Use AbortController for better browser compatibility (5 minute timeout)
        const testController = new AbortController();
        const testTimeoutId = setTimeout(() => testController.abort(), 300000);
        
        const response = await fetch(`${backendUrl}/api/admin/run-tests`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({}),
          signal: testController.signal
        });
        
        clearTimeout(testTimeoutId);
        
        const result = await response.json();
        
        // Clear progress interval
        if (progressInterval) {
          clearInterval(progressInterval);
        }
        
        // Calculate actual execution time
        const actualExecutionTime = Date.now() - startTime;
        
        // Update average execution time in localStorage
        const executionTimes = JSON.parse(localStorage.getItem('testExecutionTimes') || '[]');
        executionTimes.push(actualExecutionTime);
        // Keep only last 10 runs
        if (executionTimes.length > 10) {
          executionTimes.shift();
        }
        localStorage.setItem('testExecutionTimes', JSON.stringify(executionTimes));
        
        // Calculate average
        const avgTime = executionTimes.reduce((a, b) => a + b, 0) / executionTimes.length;
        updateAverageExecutionTime(avgTime);
        
        if (result.success) {
          // Update progress bar to 100%
          if (modalBody) {
            const progressBarFill = modalBody.querySelector('.test-progress-bar-fill');
            const currentTestEl = modalBody.querySelector('.current-test-name');
            const progressText = modalBody.querySelector('.progress-text');
            
            if (progressBarFill) {
              progressBarFill.style.width = '100%';
            }
            if (currentTestEl) {
              currentTestEl.textContent = 'Tests completed!';
            }
            if (progressText) {
              progressText.textContent = '100%';
            }
          }
          
          // Try to parse Jest output if available and update category cards
          if (result.output) {
            try {
              // Try to extract JSON from output (Jest outputs JSON at the end)
              const jsonMatch = result.output.match(/\{[\s\S]*"numTotalTests"[\s\S]*\}/);
              if (jsonMatch) {
                const jestData = JSON.parse(jsonMatch[0]);
                const parsed = parseJestOutput(jestData);
                if (parsed) {
                  Object.assign(currentTestResults, parsed);
                  updateCategoryCards(parsed);
                  safeLog('log', '‚úÖ Updated category cards from test results');
                  
                  // CRITICAL: Store in localStorage IMMEDIATELY before page reload
                  // This ensures data survives reload even if fetch fails (file:// CORS)
                  try {
                    localStorage.setItem('maya_latest_test_results', JSON.stringify(parsed));
                    dataLoaded = true; // Mark as loaded
                    console.log('‚úÖ Stored test results in localStorage BEFORE reload (from result.output)');
                    console.log('üìä Stored data:', {
                      totalTests: parsed.totalTests,
                      passingTests: parsed.passingTests,
                      testSuites: parsed.testSuites
                    });
                    safeLog('log', '‚úÖ Stored test results in localStorage before reload');
                  } catch (storageError) {
                    console.warn('‚ö†Ô∏è Failed to store in localStorage:', storageError);
                    safeLog('warn', '‚ö†Ô∏è Failed to store in localStorage:', storageError);
                  }
                }
              }
            } catch (e) {
              safeLog('warn', 'Could not parse Jest output from result:', e);
            }
          }
          
          // Reload test results from jest-results.json file with retry logic
          // Wait for file to be written, then update dashboard
          let retryCount = 0;
          const maxRetries = 10;
          const retryDelay = 1000; // 1 second between retries
          
          const reloadTestResults = async () => {
            try {
              const loaded = await loadJestResults();
              if (loaded) {
                safeLog('log', '‚úÖ Reloaded test results after completion');
                // loadJestResults() already calls updateDashboard() internally,
                // but ensure all components are updated with a small delay for DOM readiness
                setTimeout(() => {
                  updateDashboard();
                  updateTrendChart();
                  updatePassRateComparison();
                  updateFailureList(currentTestResults);
                  updatePassingTestsList(currentTestResults);
                  updateTestSummary(currentTestResults);
                  updateEvidence();
                  safeLog('log', '‚úÖ Dashboard metrics updated after test completion');
                }, 200);
                return true;
              } else if (retryCount < maxRetries) {
                retryCount++;
                safeLog('log', `‚è≥ Waiting for jest-results.json (attempt ${retryCount}/${maxRetries})...`);
                setTimeout(reloadTestResults, retryDelay);
                return false;
              } else {
                safeLog('warn', '‚ö†Ô∏è Could not load jest-results.json after retries');
                return false;
              }
            } catch (err) {
              if (retryCount < maxRetries) {
                retryCount++;
                safeLog('log', `‚è≥ Retrying load jest-results.json (attempt ${retryCount}/${maxRetries})...`);
                setTimeout(reloadTestResults, retryDelay);
                return false;
              } else {
                safeLog('warn', 'Could not reload jest-results.json:', err);
                return false;
              }
            }
          };
          
          // Start reloading after initial delay
          setTimeout(reloadTestResults, 1000);
          
          // Tests completed successfully
          let countdown = 15; // Increased to 15 seconds to allow metrics to update
          
          // Store countdown in a way that persists across DOM updates
          const countdownData = { value: countdown };
          
          const updateCountdown = () => {
            modalBody.innerHTML = `
              <div style="text-align: center; padding: var(--spacing-xl);">
                <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">‚úÖ</div>
                <h3 style="color: var(--success-color); margin-bottom: var(--spacing-sm);">Tests Completed!</h3>
                <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin: var(--spacing-md) 0;">
                  <div style="display: flex; justify-content: space-around; margin-bottom: var(--spacing-sm);">
                    <div>
                      <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">${result.results.passed}</div>
                      <div style="font-size: 0.85rem; color: var(--text-secondary);">Passed</div>
                    </div>
                    <div>
                      <div style="font-size: 1.5rem; font-weight: bold; color: ${result.results.failed > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">${result.results.failed}</div>
                      <div style="font-size: 0.85rem; color: var(--text-secondary);">Failed</div>
                    </div>
                    <div>
                      <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">${result.results.total}</div>
                      <div style="font-size: 0.85rem; color: var(--text-secondary);">Total</div>
                    </div>
                    <div>
                      <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">${result.results.passRate}%</div>
                      <div style="font-size: 0.85rem; color: var(--text-secondary);">Pass Rate</div>
                    </div>
                  </div>
                </div>
                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background-color: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--success-color);">
                  <p style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-xs);">
                    üéâ Tests completed successfully!
                  </p>
                  <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--spacing-sm);">
                    Dashboard will refresh automatically in <strong style="color: var(--accent-color); font-size: 1.1rem;" id="countdown-display">${countdownData.value}</strong> second${countdownData.value !== 1 ? 's' : ''}...
                  </p>
                  <button class="run-tests-btn" onclick="window.location.reload();" style="margin-top: var(--spacing-sm); background-color: var(--success-color); border-color: var(--success-color);">
                    Refresh Now
                  </button>
                </div>
              </div>
            `;
          };
          
          // Restore button to original state immediately
          if (btn) {
            btn.classList.remove('running', 'success', 'error');
            btn.textContent = 'üöÄ Run End-to-End Tests';
            btn.disabled = false;
          }
          
          // Show initial countdown
          updateCountdown();
          
          // Update countdown every second
          // Use a persistent reference to ensure interval continues working
          const countdownInterval = setInterval(() => {
            countdownData.value--;
            countdown = countdownData.value; // Keep in sync
            
            safeLog('log', `‚è∞ Countdown: ${countdownData.value} seconds remaining`);
            
            if (countdownData.value > 0) {
              // Update the display
              const countdownDisplay = document.getElementById('countdown-display');
              if (countdownDisplay) {
                countdownDisplay.textContent = countdownData.value;
                // Update the text after "second" as well
                const parentText = countdownDisplay.parentElement;
                if (parentText) {
                  const textAfter = parentText.textContent.split(countdownData.value + 1)[1] || '';
                  parentText.innerHTML = `Dashboard will refresh automatically in <strong style="color: var(--accent-color); font-size: 1.1rem;" id="countdown-display">${countdownData.value}</strong> second${countdownData.value !== 1 ? 's' : ''}...`;
                }
              } else {
                // Fallback: update entire modal if element not found
                updateCountdown();
              }
            } else {
              // Countdown reached zero - reload page
              safeLog('log', '‚è∞ Countdown finished (0 seconds), reloading page...');
              
              // Clear this interval first
              clearInterval(countdownInterval);
              
              // Show final message before reload (try to update modal if still open)
              const modalBodyElement = document.getElementById('test-modal-body');
              if (modalBodyElement) {
                modalBodyElement.innerHTML = `
                  <div style="text-align: center; padding: var(--spacing-xl);">
                    <div style="font-size: 2rem; margin-bottom: var(--spacing-md);">üîÑ</div>
                    <h3 style="color: var(--accent-color);">Refreshing dashboard...</h3>
                    <p style="color: var(--text-secondary); margin-top: var(--spacing-sm);">Please wait...</p>
                  </div>
                `;
              }
              
              // Store reload function globally to ensure it executes even if modal closes
              window._pendingReload = () => {
                safeLog('log', 'üîÑ Executing page reload...');
                const isFileProtocol = window.location.protocol === 'file:';
                
                try {
                  if (isFileProtocol) {
                    // For file:// protocol, use reload() first (most reliable)
                    safeLog('log', 'Using location.reload() for file:// protocol');
                    window.location.reload();
                    // If reload() doesn't work, try href assignment as immediate fallback
                    // Note: This line may not execute if reload() succeeds, which is fine
                    setTimeout(() => {
                      safeLog('log', 'Fallback: Using location.href assignment');
                      window.location.href = window.location.href;
                    }, 100);
                  } else {
                    // For http/https, use reload(true) to force reload from server
                    safeLog('log', 'Using location.reload(true) for http/https protocol');
                    try {
                      window.location.reload(true);
                    } catch (e) {
                      // Fallback to regular reload if reload(true) fails
                      safeLog('warn', 'reload(true) failed, using regular reload():', e.message);
                      window.location.reload();
                    }
                  }
                } catch (e) {
                  safeLog('error', 'Error during reload attempt:', e);
                  // Last resort: try href assignment
                  try {
                    safeLog('log', 'Last resort: Using location.href assignment');
                    window.location.href = window.location.href;
                  } catch (e2) {
                    safeLog('error', 'All reload methods failed:', e2);
                    // Show manual refresh option if modal is still accessible
                    const modalBodyEl = document.getElementById('test-modal-body');
                    if (modalBodyEl) {
                      modalBodyEl.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-xl);">
                          <div style="font-size: 2rem; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                          <h3 style="color: var(--warning-color);">Please refresh manually</h3>
                          <p style="color: var(--text-secondary); margin-top: var(--spacing-sm);">The page could not refresh automatically.</p>
                          <button class="run-tests-btn" onclick="window.location.reload();" style="margin-top: var(--spacing-md);">
                            Refresh Now
                          </button>
                        </div>
                      `;
                    }
                  }
                }
              };
              
              // Clear any active intervals/timeouts AFTER setting up reload (to avoid clearing our own timeout)
              // But clear them before the reload executes to prevent interference
              const clearActiveTimers = () => {
                if (window._activeIntervals) {
                  window._activeIntervals.forEach(interval => {
                    if (interval !== countdownInterval) {
                      clearInterval(interval);
                    }
                  });
                  window._activeIntervals = window._activeIntervals.filter(i => i !== countdownInterval);
                }
                // Don't clear _activeTimeouts here - we'll clear them right before reload
              };
              
              // Execute reload after a short delay to ensure DOM updates complete
              // Store timeout reference globally so it persists
              // Use a shorter delay (300ms) to ensure reload happens quickly but DOM updates complete
              window._reloadTimeout = setTimeout(() => {
                safeLog('log', '‚è∞ Reload timeout fired, executing reload...');
                
                // Clear any remaining timeouts/intervals right before reload
                clearActiveTimers();
                if (window._activeTimeouts) {
                  window._activeTimeouts.forEach(timeout => {
                    if (timeout !== window._reloadTimeout) {
                      clearTimeout(timeout);
                    }
                  });
                  window._activeTimeouts = [];
                }
                
                // Execute reload
                if (window._pendingReload) {
                  window._pendingReload();
                  window._pendingReload = null;
                } else {
                  safeLog('warn', '‚ö†Ô∏è _pendingReload function not found, trying direct reload...');
                  // Fallback: try direct reload if function is missing
                  try {
                    const isFileProtocol = window.location.protocol === 'file:';
                    if (isFileProtocol) {
                      window.location.reload();
                    } else {
                      window.location.reload(true);
                    }
                  } catch (e) {
                    safeLog('error', 'Direct reload failed:', e);
                  }
                }
              }, 300); // 300ms delay to show "Refreshing..." message
              
              // Store timeout in active timeouts array for tracking (but don't clear it prematurely)
              if (!window._activeTimeouts) window._activeTimeouts = [];
              window._activeTimeouts.push(window._reloadTimeout);
              
              // Clear other active timers now (but keep our reload timeout)
              clearActiveTimers();
            }
          }, 1000);
          
          // Store interval for cleanup
          if (!window._activeIntervals) window._activeIntervals = [];
          window._activeIntervals.push(countdownInterval);
        } else {
          // Tests failed or error occurred - show categorized error details
          const hasDetailedErrors = result.testFailures || result.errors || result.warnings;
          
          let errorContent = '';
          
          if (hasDetailedErrors) {
            // Categorized error display
            errorContent = `
              <div style="text-align: left; max-height: 60vh; overflow-y: auto;">
                ${result.testFailures && result.testFailures.length > 0 ? `
                <div style="margin-bottom: var(--spacing-lg);">
                  <h4 style="color: var(--danger-color); margin-bottom: var(--spacing-sm); font-size: 1.1rem;">
                    üî¥ Test Failures (${result.testFailures.length})
                  </h4>
                  <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); border-left: 4px solid var(--danger-color);">
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.6;">
                      ${result.testFailures.map(failure => `<li style="margin-bottom: var(--spacing-xs);">${failure.replace(/FAIL\s+/, '<strong style="color: var(--danger-color);">FAIL</strong> ')}</li>`).join('')}
                    </ul>
                  </div>
                </div>
                ` : ''}
                
                ${result.errors && result.errors.length > 0 ? `
                <div style="margin-bottom: var(--spacing-lg);">
                  <h4 style="color: var(--warning-color); margin-bottom: var(--spacing-sm); font-size: 1.1rem;">
                    ‚ö†Ô∏è Errors (${result.errors.length})
                  </h4>
                  <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); border-left: 4px solid var(--warning-color); max-height: 200px; overflow-y: auto;">
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.6;">
                      ${result.errors.slice(0, 10).map(error => `<li style="margin-bottom: var(--spacing-xs); word-break: break-all;">${error}</li>`).join('')}
                    </ul>
                  </div>
                </div>
                ` : ''}
                
                ${result.warnings && result.warnings.length > 0 ? `
                <div style="margin-bottom: var(--spacing-lg);">
                  <h4 style="color: var(--info-color); margin-bottom: var(--spacing-sm); font-size: 1.1rem;">
                    ‚ÑπÔ∏è Warnings (${result.warnings.length}) - Can be ignored
                  </h4>
                  <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); border-left: 4px solid var(--info-color); max-height: 150px; overflow-y: auto;">
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--text-muted); font-family: 'Courier New', monospace; font-size: 0.8rem; line-height: 1.5;">
                      ${result.warnings.slice(0, 5).map(warning => `<li style="margin-bottom: var(--spacing-xs);">${warning}</li>`).join('')}
                    </ul>
                  </div>
                </div>
                ` : ''}
                
                ${result.details ? `
                <div style="margin-bottom: var(--spacing-lg);">
                  <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-sm); font-size: 1.1rem;">
                    üìã Execution Details
                  </h4>
                  <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md);">
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">
                      <p><strong>Command:</strong> <code style="background-color: var(--bg-primary); padding: 2px 6px; border-radius: 3px;">${result.details.command || 'npm test'}</code></p>
                      <p><strong>Error Code:</strong> ${result.details.code || 'Unknown'}</p>
                      ${result.details.signal ? `<p><strong>Signal:</strong> ${result.details.signal}</p>` : ''}
                    </div>
                  </div>
                </div>
                ` : ''}
              </div>
            `;
          } else {
            // Simple error message if no detailed errors
            errorContent = `
              <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                ${result.message || result.error || 'Unknown error occurred'}
              </p>
            `;
          }
          
          modalBody.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl);">
              <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">‚ùå</div>
              <h3 style="color: var(--danger-color); margin-bottom: var(--spacing-sm);">Test Execution Failed</h3>
              ${errorContent}
              <div style="display: flex; gap: var(--spacing-sm); justify-content: center; margin-top: var(--spacing-lg);">
                <button class="run-tests-btn" onclick="closeRunTestsModal(); resetRunButton();">
                  Close
                </button>
                <button class="run-tests-btn" onclick="closeRunTestsModal(); runE2ETests();" style="background-color: var(--info-color); border-color: var(--info-color);">
                  üîÑ Retry Tests
                </button>
              </div>
            </div>
          `;
          
          // Restore button to original state
          if (btn) {
            btn.classList.remove('running', 'success', 'error');
            btn.textContent = 'üöÄ Run End-to-End Tests';
            btn.disabled = false;
          }
        }
      } catch (error) {
        // Clear progress interval
        if (progressInterval) {
          clearInterval(progressInterval);
        }
        
        safeLog('error', 'Error running tests:', error);
        
        // Determine error type
        const isServerNotRunning = error.message === 'SERVER_NOT_RUNNING' || 
                                   error.name === 'TypeError' || 
                                   error.message.includes('Failed to fetch') ||
                                   error.message.includes('NetworkError');
        
        const errorMessage = isServerNotRunning
          ? 'Backend server is not running. Please start the server first.'
          : error.message || 'An unexpected error occurred while running tests.';
        
        modalBody.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
            <h3 style="color: var(--warning-color); margin-bottom: var(--spacing-sm);">Connection Error</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
              ${errorMessage}
            </p>
            ${isServerNotRunning ? `
            <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin: var(--spacing-md) 0; text-align: left;">
              <strong style="color: var(--text-primary); margin-bottom: var(--spacing-sm); display: block;">To start the backend server:</strong>
              <code style="display: block; margin-top: var(--spacing-xs); padding: var(--spacing-sm); background-color: var(--bg-primary); border-radius: 4px; font-family: 'Courier New', monospace; color: var(--text-primary);">
                cd Maya/backend && npm start
              </code>
              <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: var(--spacing-sm);">
                Or use: <code style="background-color: var(--bg-primary); padding: 2px 6px; border-radius: 3px;">./start.sh</code>
              </p>
            </div>
            <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin: var(--spacing-md) 0; text-align: left;">
              <strong style="color: var(--text-primary); margin-bottom: var(--spacing-sm); display: block;">To run tests manually (without server):</strong>
              <code style="display: block; margin-top: var(--spacing-xs); padding: var(--spacing-sm); background-color: var(--bg-primary); border-radius: 4px; font-family: 'Courier New', monospace; color: var(--text-primary);">
                cd Maya/backend && npm test -- --json --outputFile=../tests/jest-results.json
              </code>
            </div>
            ` : ''}
            <div style="display: flex; gap: var(--spacing-sm); justify-content: center; margin-top: var(--spacing-md);">
              <button class="run-tests-btn" onclick="checkServerStatus();" style="background-color: var(--info-color); border-color: var(--info-color);">
                üîç Check Server Status
              </button>
              <button class="run-tests-btn" onclick="closeRunTestsModal(); resetRunButton();">
                Close
              </button>
            </div>
          </div>
        `;
        
        // Restore button to original state
        if (btn) {
          btn.classList.remove('running', 'success', 'error');
          btn.textContent = 'üöÄ Run End-to-End Tests';
          btn.disabled = false;
        }
      }
    }
    
    function resetRunButton() {
      const btn = document.getElementById('run-e2e-tests-btn');
      if (btn) {
        btn.classList.remove('running', 'success', 'error');
        btn.textContent = 'üöÄ Run End-to-End Tests';
        btn.disabled = false;
      }
    }

    function closeRunTestsModal() {
      const modal = document.getElementById('run-tests-modal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Check server status
    async function checkServerStatus() {
      const modal = document.getElementById('run-tests-modal');
      const modalBody = document.getElementById('test-modal-body');
      
      if (!modalBody) return;
      
      // Show checking status
      modalBody.innerHTML = `
        <div style="text-align: center; padding: var(--spacing-xl);">
          <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üîç</div>
          <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">Checking Server Status...</h3>
          <div style="display: flex; justify-content: center; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
            <div class="loading-dot" style="animation-delay: 0s;"></div>
            <div class="loading-dot" style="animation-delay: 0.2s;"></div>
            <div class="loading-dot" style="animation-delay: 0.4s;"></div>
          </div>
        </div>
      `;
      
      if (modal) {
        modal.classList.add('active');
      }
      
      try {
        const backendUrl = window.location.origin.includes('localhost') || window.location.protocol === 'file:'
          ? 'http://localhost:3001' 
          : window.location.origin.replace(/:\d+/, ':3001');
        
        let healthResponse;
        let healthData;
        
        try {
          // Use AbortController for better browser compatibility
          const checkController = new AbortController();
          const checkTimeoutId = setTimeout(() => checkController.abort(), 5000);
          
          healthResponse = await fetch(`${backendUrl}/health`, {
            method: 'GET',
            mode: 'cors',
            signal: checkController.signal
          });
          
          clearTimeout(checkTimeoutId);
          
          if (!healthResponse.ok) {
            throw new Error(`Server returned status ${healthResponse.status}`);
          }
          
          healthData = await healthResponse.json();
        } catch (fetchError) {
          // Check if it's a CORS error
          if (fetchError.name === 'TypeError' && fetchError.message.includes('Failed to fetch')) {
            // Could be CORS issue - try to provide helpful message
            const isCorsError = window.location.protocol === 'file:';
            modalBody.innerHTML = `
              <div style="text-align: center; padding: var(--spacing-xl);">
                <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">‚ö†Ô∏è</div>
                <h3 style="color: var(--warning-color); margin-bottom: var(--spacing-sm);">Connection Issue</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                  ${isCorsError 
                    ? 'Cannot verify server status due to browser security restrictions when opening HTML files directly. The server may be running, but browsers block CORS requests from file:// protocol.'
                    : `Could not connect to backend server at ${backendUrl}`
                  }
                </p>
                ${isCorsError ? `
                <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin: var(--spacing-md) 0; text-align: left;">
                  <strong style="color: var(--text-primary); margin-bottom: var(--spacing-sm); display: block;">Solutions:</strong>
                  <ul style="color: var(--text-secondary); margin-top: var(--spacing-xs); padding-left: var(--spacing-lg);">
                    <li>Open the dashboard via a local server (e.g., <code>python -m http.server</code> or <code>npx serve</code>)</li>
                    <li>Or try running tests directly - if server is running, tests should work</li>
                    <li>Check browser console for detailed error messages</li>
                  </ul>
                </div>
                ` : `
                <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin: var(--spacing-md) 0; text-align: left;">
                  <strong style="color: var(--text-primary); margin-bottom: var(--spacing-sm); display: block;">To start the server:</strong>
                  <code style="display: block; margin-top: var(--spacing-xs); padding: var(--spacing-sm); background-color: var(--bg-primary); border-radius: 4px; font-family: 'Courier New', monospace; color: var(--text-primary);">
                    cd Maya/backend && npm start
                  </code>
                </div>
                `}
                <div style="display: flex; gap: var(--spacing-sm); justify-content: center; margin-top: var(--spacing-md);">
                  <button class="run-tests-btn" onclick="closeRunTestsModal(); runE2ETests();" style="background-color: var(--info-color); border-color: var(--info-color);">
                    Try Running Tests Anyway
                  </button>
                  <button class="run-tests-btn" onclick="closeRunTestsModal();">
                    Close
                  </button>
                </div>
              </div>
            `;
            return;
          }
          throw fetchError;
        }
        
        // Server is running and responded successfully
        modalBody.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">‚úÖ</div>
            <h3 style="color: var(--success-color); margin-bottom: var(--spacing-sm);">Server is Running</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
              Backend server is available at ${backendUrl}
            </p>
            <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin: var(--spacing-md) 0; text-align: left;">
              <strong style="color: var(--text-primary);">Server Status:</strong>
              <ul style="color: var(--text-secondary); margin-top: var(--spacing-xs); padding-left: var(--spacing-lg);">
                <li>Status: ${healthData.status || 'OK'}</li>
                <li>Port: ${backendUrl.split(':').pop()}</li>
                <li>Environment: ${healthData.environment || 'unknown'}</li>
                <li>Timestamp: ${new Date().toLocaleString()}</li>
              </ul>
            </div>
            <button class="run-tests-btn" onclick="closeRunTestsModal(); runE2ETests();" style="margin-top: var(--spacing-md); background-color: var(--success-color); border-color: var(--success-color);">
              üöÄ Run Tests Now
            </button>
            <button class="run-tests-btn" onclick="closeRunTestsModal();" style="margin-top: var(--spacing-sm);">
              Close
            </button>
          </div>
        `;
      } catch (error) {
        safeLog('error', 'Error checking server status:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">‚ùå</div>
            <h3 style="color: var(--danger-color); margin-bottom: var(--spacing-sm);">Server Check Failed</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
              Error: ${error.message || 'Unknown error occurred'}
            </p>
            <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: var(--spacing-md); margin: var(--spacing-md) 0; text-align: left;">
              <strong style="color: var(--text-primary); margin-bottom: var(--spacing-sm); display: block;">Troubleshooting:</strong>
              <ul style="color: var(--text-secondary); margin-top: var(--spacing-xs); padding-left: var(--spacing-lg);">
                <li>Verify server is running: <code>curl http://localhost:3001/health</code></li>
                <li>Check server logs for errors</li>
                <li>Try running tests directly - they may still work</li>
              </ul>
            </div>
            <div style="display: flex; gap: var(--spacing-sm); justify-content: center; margin-top: var(--spacing-md);">
              <button class="run-tests-btn" onclick="closeRunTestsModal(); runE2ETests();" style="background-color: var(--info-color); border-color: var(--info-color);">
                Try Running Tests Anyway
              </button>
              <button class="run-tests-btn" onclick="closeRunTestsModal();">
                Close
              </button>
            </div>
          </div>
        `;
      }
    }


    function copyTestCommand() {
      const commandText = document.getElementById('test-command-text');
      const copyBtn = document.getElementById('copy-command-btn');
      
      if (commandText && copyBtn) {
        const command = commandText.textContent;
        navigator.clipboard.writeText(command).then(() => {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          // Store timeout ID for potential cleanup
          const resetTimeout = setTimeout(() => {
            copyBtn.textContent = 'Copy';
            copyBtn.classList.remove('copied');
          }, 2000);
          
          // Store timeout ID globally for cleanup if needed
          window._activeTimeouts = window._activeTimeouts || [];
          window._activeTimeouts.push(resetTimeout);
        }).catch(err => {
          safeLog('error', 'Failed to copy:', err);
          // Fallback: select text
          const range = document.createRange();
          range.selectNode(commandText);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);
          copyBtn.textContent = 'Select & Copy';
        });
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('run-tests-modal');
      if (event.target === modal) {
        closeRunTestsModal();
      }
    }

    // Update average execution time display
    function updateAverageExecutionTime(avgTimeMs) {
      const avgTimeEl = document.getElementById('avg-execution-time');
      if (avgTimeEl) {
        const avgSeconds = (avgTimeMs / 1000).toFixed(1);
        const runCount = JSON.parse(localStorage.getItem('testExecutionTimes') || '[]').length;
        avgTimeEl.textContent = `~${avgSeconds} seconds (based on last ${runCount} run${runCount !== 1 ? 's' : ''})`;
      }
    }
    
    // Load and display average execution time on page load
    function loadAverageExecutionTime() {
      const executionTimes = JSON.parse(localStorage.getItem('testExecutionTimes') || '[]');
      if (executionTimes.length > 0) {
        const avgTime = executionTimes.reduce((a, b) => a + b, 0) / executionTimes.length;
        updateAverageExecutionTime(avgTime);
      } else {
        const avgTimeEl = document.getElementById('avg-execution-time');
        if (avgTimeEl) {
          avgTimeEl.textContent = '~45 seconds (estimated)';
        }
      }
    }
    
    // Load average execution time first (doesn't depend on test results)
    loadAverageExecutionTime();
    
    // Set up button click handler (using event listener for better reliability)
    function setupRunTestsButton() {
      console.log('üîß Setting up run tests button...');
      console.log('üîß Document ready state:', document.readyState);
      console.log('üîß Button element exists:', !!document.getElementById('run-e2e-tests-btn'));
      console.log('üîß showRunTestsModal function exists:', typeof window.showRunTestsModal);
      
      const runTestsBtn = document.getElementById('run-e2e-tests-btn');
      if (runTestsBtn) {
        // Remove any existing event listeners by cloning and replacing
        const newBtn = runTestsBtn.cloneNode(true);
        runTestsBtn.parentNode.replaceChild(newBtn, runTestsBtn);
        
        // Get the new button reference
        const btn = document.getElementById('run-e2e-tests-btn');
        
        // Add event listener with comprehensive error handling
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üöÄ Button clicked!');
          console.log('üöÄ showRunTestsModal type:', typeof window.showRunTestsModal);
          
          if (typeof window.showRunTestsModal === 'function') {
            try {
              window.showRunTestsModal();
            } catch (error) {
              console.error('‚ùå Error calling showRunTestsModal:', error);
              alert('Error: Failed to start test execution. Please check the console for details.');
            }
          } else {
            console.error('‚ùå showRunTestsModal not found on window');
            console.error('‚ùå Available window properties:', Object.keys(window).filter(k => k.includes('show') || k.includes('Run')));
            alert('Error: Test execution function not available. Please refresh the page.');
          }
        }, { capture: true }); // Use capture phase to ensure we catch the event
        
        // Also add as direct onclick as fallback
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üöÄ Button clicked (onclick fallback)!');
          if (typeof window.showRunTestsModal === 'function') {
            window.showRunTestsModal();
          }
        };
        
        console.log('‚úÖ Run tests button event listener attached');
        console.log('‚úÖ Button is clickable:', !btn.disabled);
        console.log('‚úÖ Button style:', window.getComputedStyle(btn).pointerEvents);
      } else {
        console.error('‚ùå run-e2e-tests-btn button not found');
        console.error('‚ùå Available buttons:', Array.from(document.querySelectorAll('button')).map(b => b.id || b.className));
      }
    }
    
    // Set up button with multiple retry attempts
    function setupButtonWithRetry(maxRetries = 5, delay = 100) {
      let attempts = 0;
      
      function trySetup() {
        attempts++;
        console.log(`üîß Attempt ${attempts} to setup button...`);
        
        const btn = document.getElementById('run-e2e-tests-btn');
        const funcExists = typeof window.showRunTestsModal === 'function';
        
        if (btn && funcExists) {
          setupRunTestsButton();
          console.log('‚úÖ Button setup successful!');
        } else if (attempts < maxRetries) {
          console.log(`‚è≥ Retrying in ${delay}ms... (button: ${!!btn}, function: ${funcExists})`);
          setTimeout(trySetup, delay);
        } else {
          console.error('‚ùå Failed to setup button after', maxRetries, 'attempts');
          setupRunTestsButton(); // Try one more time anyway
        }
      }
      
      trySetup();
    }
    
    // Set up button when DOM is ready
    if (document.readyState === 'loading') {
      console.log('‚è≥ DOM still loading, waiting for DOMContentLoaded...');
      document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOMContentLoaded fired');
        setTimeout(() => setupButtonWithRetry(), 100); // Small delay to ensure everything is ready
      });
    } else {
      console.log('‚úÖ DOM already loaded, setting up button...');
      // DOM already loaded, but add a small delay to ensure all scripts have executed
      setTimeout(() => setupButtonWithRetry(), 100);
    }
    
    // Try to load actual Jest results FIRST before initializing dashboard
    // This ensures data is available when updateDashboard() is called
    // Note: loadJestResults() will call updateDashboard() internally when data is loaded
    // CRITICAL: Wait for DOM to be ready before calling loadJestResults()
    // This ensures all DOM elements exist when updateMetricCards() tries to find them
    function initializeDashboard() {
      console.log('üîÑ Initializing dashboard...');
      console.log('üìä DOM ready state:', document.readyState);
      
      // Verify DOM elements exist before proceeding
      const totalEl = document.getElementById('total-tests');
      const passingEl = document.getElementById('passing-tests');
      console.log('üîç DOM elements check:', {
        'total-tests': totalEl ? 'found' : 'NOT FOUND',
        'passing-tests': passingEl ? 'found' : 'NOT FOUND'
      });
      
      if (!totalEl || !passingEl) {
        console.warn('‚ö†Ô∏è DOM elements not ready yet, retrying in 100ms...');
        setTimeout(initializeDashboard, 100);
        return;
      }
      
      console.log('‚úÖ DOM elements ready, loading Jest results...');
      loadJestResults().then(loaded => {
        console.log('üìä loadJestResults completed, loaded:', loaded);
        console.log('üìä dataLoaded flag:', dataLoaded);
        if (loaded) {
          console.log('‚úÖ Loaded test results, dashboard updated');
          console.log('üìä currentTestResults:', {
            totalTests: currentTestResults.totalTests,
            passingTests: currentTestResults.passingTests,
            testSuites: currentTestResults.testSuites
          });
          safeLog('log', '‚úÖ Loaded test results, dashboard updated');
          
          // Force a second update after a small delay to ensure all metrics are refreshed
          setTimeout(() => {
            console.log('üîÑ Force refreshing dashboard metrics after load...');
            safeLog('log', 'üîÑ Force refreshing dashboard metrics after load...');
            
            // Verify currentTestResults still has data
            console.log('üìä currentTestResults before force refresh:', {
              totalTests: currentTestResults.totalTests,
              passingTests: currentTestResults.passingTests,
              testSuites: currentTestResults.testSuites
            });
            
            // Verify DOM elements still exist
            const totalElCheck = document.getElementById('total-tests');
            const passingElCheck = document.getElementById('passing-tests');
            console.log('üîç DOM elements check before force refresh:', {
              'total-tests': totalElCheck ? 'found' : 'NOT FOUND',
              'passing-tests': passingElCheck ? 'found' : 'NOT FOUND'
            });
            
            if (totalElCheck && passingElCheck) {
              updateDashboard();
              updateMetricCards(currentTestResults);
              updateCategoryCards(currentTestResults);
              updateTestScopeTable(currentTestResults);
              updateCoverageInfo(currentTestResults);
              
              // Final verification
              setTimeout(() => {
                const totalElFinal = document.getElementById('total-tests');
                const passingElFinal = document.getElementById('passing-tests');
                const suitesElFinal = document.getElementById('test-suites');
                console.log('üîç Final verification after force refresh:');
                console.log('  total-tests:', totalElFinal?.textContent, 'expected:', currentTestResults.totalTests);
                console.log('  passing-tests:', passingElFinal?.textContent, 'expected:', currentTestResults.passingTests);
                console.log('  test-suites:', suitesElFinal?.textContent, 'expected:', currentTestResults.testSuites);
                
                // If values don't match, try one more time
                if (totalElFinal && totalElFinal.textContent !== String(currentTestResults.totalTests || 0)) {
                  console.warn('‚ö†Ô∏è Values still don\'t match, forcing one more update...');
                  updateMetricCards(currentTestResults);
                }
              }, 100);
            } else {
              console.warn('‚ö†Ô∏è DOM elements not found during force refresh, retrying...');
              setTimeout(() => {
                updateDashboard();
                updateMetricCards(currentTestResults);
                updateCategoryCards(currentTestResults);
              }, 200);
            }
            
            safeLog('log', '‚úÖ Dashboard metrics force-refreshed');
          }, 500);
        } else {
          console.log('‚ÑπÔ∏è No test results file found, using default values');
          safeLog('log', '‚ÑπÔ∏è No test results file found, using default values');
          // CRITICAL: Mark data as loaded even if no file found, so UI shows "0" instead of "Loading..."
          console.log('‚ö†Ô∏è Marking dataLoaded = true (no file found, showing defaults)');
          dataLoaded = true;
          // If no data loaded, initialize dashboard with defaults
          updateDashboard();
          setTimeout(() => updateTrendChart(), 100);
          updatePassRateComparison();
          updateFailureList(currentTestResults);
          updatePassingTestsList(currentTestResults);
          updateTestSummary(currentTestResults);
          updateEvidence();
        }
      }).catch(error => {
        console.error('‚ùå Error loading Jest results:', error);
        safeLog('error', '‚ùå Error loading Jest results:', error);
        // CRITICAL: Mark data as loaded even on error, so UI shows "0" instead of "Loading..."
        console.log('‚ö†Ô∏è Marking dataLoaded = true (error occurred, showing defaults)');
        dataLoaded = true;
        // Still initialize dashboard with defaults
        updateDashboard();
      });
    }
    
    // Auto-refresh functionality
    let autoRefreshInterval = null;
    let lastRefreshTime = null;
    const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds
    
    function startAutoRefresh() {
      // Clear any existing interval
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      
      // Set up auto-refresh
      autoRefreshInterval = setInterval(() => {
        console.log('üîÑ Auto-refreshing dashboard...');
        lastRefreshTime = new Date();
        loadJestResults().then(loaded => {
          if (loaded) {
            updateDashboard();
            updateMetricCards(currentTestResults);
            updateCategoryCards(currentTestResults);
            updateTestScopeTable(currentTestResults);
            updateCoverageInfo(currentTestResults);
            updateTrendChart();
            updatePassRateComparison();
            updateFailureList(currentTestResults);
            updatePassingTestsList(currentTestResults);
            updateTestSummary(currentTestResults);
            updateEvidence();
            console.log('‚úÖ Dashboard auto-refreshed at', lastRefreshTime.toLocaleTimeString());
            safeLog('log', `‚úÖ Dashboard auto-refreshed at ${lastRefreshTime.toLocaleTimeString()}`);
          }
        }).catch(error => {
          console.error('‚ùå Error during auto-refresh:', error);
          safeLog('error', '‚ùå Error during auto-refresh:', error);
        });
      }, AUTO_REFRESH_INTERVAL);
      
      console.log(`‚úÖ Auto-refresh started (every ${AUTO_REFRESH_INTERVAL / 1000} seconds)`);
    }
    
    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('‚è∏Ô∏è Auto-refresh stopped');
      }
    }
    
    // Update last refresh time display
    function updateLastRefreshDisplay() {
      const refreshIndicator = document.getElementById('last-refresh-time');
      if (refreshIndicator && lastRefreshTime) {
        const timeStr = lastRefreshTime.toLocaleTimeString();
        refreshIndicator.textContent = `Last refreshed: ${timeStr}`;
        refreshIndicator.style.color = 'var(--text-secondary)';
        refreshIndicator.style.fontSize = '0.875rem';
      }
    }
    
    // Start auto-refresh after initial dashboard load
    function initializeDashboardWithAutoRefresh() {
      initializeDashboard();
      // Start auto-refresh after a short delay to ensure initial load completes
      setTimeout(() => {
        startAutoRefresh();
        // Update refresh indicator every second
        setInterval(updateLastRefreshDisplay, 1000);
      }, 2000);
    }
    
    // Wait for DOM to be ready before initializing dashboard
    if (document.readyState === 'loading') {
      console.log('‚è≥ DOM still loading, waiting for DOMContentLoaded before initializing dashboard...');
      document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOMContentLoaded fired, initializing dashboard...');
        setTimeout(initializeDashboardWithAutoRefresh, 200); // Small delay to ensure all elements are rendered
      });
    } else {
      console.log('‚úÖ DOM already loaded, initializing dashboard...');
      // DOM already loaded, but add a small delay to ensure all scripts have executed
      setTimeout(initializeDashboardWithAutoRefresh, 200);
    }
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      stopAutoRefresh();
    });
  </script>
</body>
</html>
